<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>AWS Cloud Security Deployment - Terraform | Tilly Net</title>
<meta name="keywords" content="aws, ec2, vpc, bastion, jumpbox">
<meta name="description" content="Overview
This document summarizes the technical work completed today to build, configure, and automate a secure AWS VPC lab using Terraform. It covers manual and automated infrastructure steps, with detailed explanations for each Terraform configuration component, designed to help replicate the setup at any time in the future.

Objectives


Build a segmented AWS VPC network with public and private subnets.


Launch EC2 instances in both public and private subnets.


Secure access using Security Groups.">
<meta name="author" content="">
<link rel="canonical" href="https://blog.tillynet.com/cloud-engineering-labs/aws-lab-1/aws-cloud-security-lab-summary-terraform-project/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.tillynet.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.tillynet.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.tillynet.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.tillynet.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.tillynet.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://blog.tillynet.com/cloud-engineering-labs/aws-lab-1/aws-cloud-security-lab-summary-terraform-project/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://blog.tillynet.com/cloud-engineering-labs/aws-lab-1/aws-cloud-security-lab-summary-terraform-project/">
  <meta property="og:site_name" content="Tilly Net">
  <meta property="og:title" content="AWS Cloud Security Deployment - Terraform">
  <meta property="og:description" content="Overview This document summarizes the technical work completed today to build, configure, and automate a secure AWS VPC lab using Terraform. It covers manual and automated infrastructure steps, with detailed explanations for each Terraform configuration component, designed to help replicate the setup at any time in the future.
Objectives Build a segmented AWS VPC network with public and private subnets.
Launch EC2 instances in both public and private subnets.
Secure access using Security Groups.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="cloud-engineering-labs">
    <meta property="article:published_time" content="2025-05-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-05-27T00:00:00+00:00">
    <meta property="article:tag" content="Aws">
    <meta property="article:tag" content="Ec2">
    <meta property="article:tag" content="Vpc">
    <meta property="article:tag" content="Bastion">
    <meta property="article:tag" content="Jumpbox">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AWS Cloud Security Deployment - Terraform">
<meta name="twitter:description" content="Overview
This document summarizes the technical work completed today to build, configure, and automate a secure AWS VPC lab using Terraform. It covers manual and automated infrastructure steps, with detailed explanations for each Terraform configuration component, designed to help replicate the setup at any time in the future.

Objectives


Build a segmented AWS VPC network with public and private subnets.


Launch EC2 instances in both public and private subnets.


Secure access using Security Groups.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Cloud-Engineering-Labs",
      "item": "https://blog.tillynet.com/cloud-engineering-labs/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "AWS Cloud Security Deployment - Terraform",
      "item": "https://blog.tillynet.com/cloud-engineering-labs/aws-lab-1/aws-cloud-security-lab-summary-terraform-project/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "AWS Cloud Security Deployment - Terraform",
  "name": "AWS Cloud Security Deployment - Terraform",
  "description": "Overview This document summarizes the technical work completed today to build, configure, and automate a secure AWS VPC lab using Terraform. It covers manual and automated infrastructure steps, with detailed explanations for each Terraform configuration component, designed to help replicate the setup at any time in the future.\nObjectives Build a segmented AWS VPC network with public and private subnets.\nLaunch EC2 instances in both public and private subnets.\nSecure access using Security Groups.\n",
  "keywords": [
    "aws", "ec2", "vpc", "bastion", "jumpbox"
  ],
  "articleBody": "Overview This document summarizes the technical work completed today to build, configure, and automate a secure AWS VPC lab using Terraform. It covers manual and automated infrastructure steps, with detailed explanations for each Terraform configuration component, designed to help replicate the setup at any time in the future.\nObjectives Build a segmented AWS VPC network with public and private subnets.\nLaunch EC2 instances in both public and private subnets.\nSecure access using Security Groups.\nEnable VPC Flow Logs for traffic monitoring.\nManage the infrastructure using Terraform, with variables and data sources referencing existing AWS resources.\nPrerequisites An AWS Free Tier account.\nAWS CLI installed and configured (aws configure) with IAM user access keys.\nTerraform installed on the local workstation.\nAn existing VPC created manually in AWS.\nAn EC2 SSH Key Pair created in AWS (with the .pem file downloaded and stored securely).\nTerraform Project Structure /terraform-vpc-lab\r├── provider.tf\r├── variables.tf\r├── data.tf\r├── locals.tf\r├── main.tf\r├── outputs.tf\r├── terraform.tfvars\r└── user-data\r├── deploy-terraform.ps1\r├── private-userdata.sh\r└── public-userdata.sh Each file has a specific purpose, described in detail below.\nprovider.tf provider \"aws\" {\rregion = \"us-east-1\"\r} Explanation:\nDefines the AWS provider Terraform will use.\nSets the default AWS region to us-west-1. This can be adjusted or turned into a configurable variable if needed.\nvariables.tf The variables.tf file defines all the input variables your Terraform configuration uses, making it:\nFlexible Resusable Easier to manage across environments (dev, staging, prod) By declaring variables here we avoid hardcoding values in main.tf or other resource files. # variables.tf - defines and validates variables\rvariable \"vpc_cidr\" {\rdescription = \"CIDR block for the new VPC\"\rtype = string\rdefault = \"10.0.0.0/16\"\rvalidation {\rcondition = can(cidrhost(var.vpc_cidr, 0))\rerror_message = \"VPC CIDR must be a valid IPv4 CIDR block.\"\r}\r}\r# defines which AWS Availability zone to deploy into\rvariable \"availability_zone\" {\rdescription = \"The AWS Availability Zone\"\rtype = string\rdefault = \"us-west-1a\"\r# regex validation to ensure the format matches AWS AZ patterns\rvalidation {\rcondition = can(regex(\"^[a-z]{2}-[a-z]+-[0-9][a-z]$\", var.availability_zone))\rerror_message = \"Availability zone must be in the format like 'us-west-1a'.\"\r}\r}\r# Defines the IP range for the public subnet\rvariable \"public_subnet_cidr\" {\rdescription = \"CIDR block for the public subnet\"\rtype = string\rdefault = \"10.0.1.0/24\"\r# CIDR validation check\rvalidation {\rcondition = can(cidrhost(var.public_subnet_cidr, 0))\rerror_message = \"Public subnet CIDR must be a valid IPv4 CIDR block.\"\r}\r}\r# Defines the IP range for the private subnet\rvariable \"private_subnet_cidr\" {\rdescription = \"CIDR block for the private subnet\"\rtype = string\rdefault = \"10.0.2.0/24\"\r# CIDR validation check\rvalidation {\rcondition = can(cidrhost(var.private_subnet_cidr, 0))\rerror_message = \"Private subnet CIDR must be a valid IPv4 CIDR block.\"\r}\r}\r# Specifies the name of the EC2 SSH key pair used for connecting to instances.\rvariable \"key_name\" {\rdescription = \"The name of the EC2 SSH key pair\"\rtype = string\r}\r# Used in security group rules to restrict SSH access\r# requires a /32 CIDR notation\rvariable \"home_ip\" {\rdescription = \"Your home public IP address with /32 mask (e.g., 203.0.113.1/32)\"\rtype = string\r# Regex validation to ensure proper format\rvalidation {\rcondition = can(regex(\"^([0-9]{1,3}\\\\.){3}[0-9]{1,3}/32$\", var.home_ip))\rerror_message = \"Home IP must be a valid IPv4 address with /32 mask (e.g., 203.0.113.1/32).\"\r}\r}\r# Used for tagging AWS resources for identification\r# Helps track whick resources belong to whick project\rvariable \"project_name\" {\rdescription = \"Name of the project for resource tagging\"\rtype = string\rdefault = \"terraform-vpc-demo\"\r}\r# Tags resources or configures settings per environment\rvariable \"environment\" {\rdescription = \"Environment name (dev, staging, prod)\"\rtype = string\rdefault = \"dev\"\r# Ensures only use valid environment names\rvalidation {\rcondition = contains([\"dev\", \"staging\", \"prod\"], var.environment)\rerror_message = \"Environment must be one of: dev, staging, prod.\"\r}\r}\r# Controls the size of the EC2 instances\r# Below is freet-tier eligible\rvariable \"instance_type\" {\rdescription = \"EC2 instance type\"\rtype = string\rdefault = \"t2.micro\"\r}\r# Controls whether DNS hostnames is enabled for the VPC\r# Belowis set to true - best practice\rvariable \"enable_dns_hostnames\" {\rdescription = \"Enable DNS hostnames in the VPC\"\rtype = bool\rdefault = true\r}\r# Controls whether DNS support is enabled for the VPC\r# Below set to true - best practice\rvariable \"enable_dns_support\" {\rdescription = \"Enable DNS support in the VPC\"\rtype = bool\rdefault = true\r} Explanation:\nDefines all required input variables, including the VPC, subnet CIDRs, key pair name, and the home public IP address for secure SSH access. Modular and adaptable to different setups. Safter through built-in validation blocks. Easier to manage across environments by externalizing critical settings. terraform.tfvars # terraform.tfvars - define sensitive values\rkey_name = \"AWS_key_name\"\rhome_ip = \"publicIP/32\"\rproject_name = \"project name\"\renvironment = \"dev\"\rvpc_cidr = \"10.0.0.0/16\"\rpublic_subnet_cidr = \"10.0.1.0/24\"\rprivate_subnet_cidr = \"10.0.2.0/24\"\ravailability_zone = \"us-west-1a\"\rinstance_type = \"t2.micro\" Explanation:\nProvides actual values for the variables defined in variables.tf.\nThis file is automatically loaded by Terraform and should be excluded from version control for sensitive values.\ndata.tf This file defines Terraform data sources, which allows the ability to query AWS for existing dynamic information that is not created or managed directly, such as available regions, caller identity, AMI IDs, or availability zones.\nThese values can be used throughout Terraform configurations for dynamic, up-to-date references.\n# data.tf - Centralize data sources\r# Fetches the AWS region that Terraform is currently operating in\r# Useful to reference the region dynamically in resources or outputs without hardcoding var.region everwhere\rdata \"aws_region\" \"current\" {}\r# Returns details about the active AWS identity: AWS account ID, Amazon Resource Name (ARN), User ID\r# Useful for tagging, auditing, or conditional logic tied to the current account\rdata \"aws_caller_identity\" \"current\" {}\r# Returns a list of available AZs in the current region\r# Can be used to distribute resources across zones for HA\r# below is only including AZs in the \"available\" state\rdata \"aws_availability_zones\" \"available\" {\rstate = \"available\"\r}\r# Looks up the most recent official Amazon Linux 2 AMI\r# Ensures that EC2 instances are always built from the latest Amazon-maintained AMI, reducing the need to hardcode AMI IDs\rdata \"aws_ami\" \"amazon_linux\" {\rmost_recent = true\rowners = [\"amazon\"]\rfilter {\rname = \"name\"\rvalues = [\"amzn2-ami-hvm-*-x86_64-gp2\"] # HVM-based, general-purpose SSD, 64-bit\r}\rfilter {\rname = \"virtualization-type\" # sets virtualization type to HVM\rvalues = [\"hvm\"]\r}\r} Explanation:\nUses Terraform’s data sources to reference existing AWS resources without Terraform managing or creating them. Makes Terraform configuration more dynamic and adaptable. Reduce hardcoding of values that might change between regions, accounts, or over time. Help ensure that the infrastructure always targets the correct, most up-to-date AWS resources. locals.tf The locals block in Terrraform defines computed values or constants that can be reused throughout the configuration. The computed values and constants help reduce repetition, centralize logic, and make configurations easier to maintain. These are like reusable variables, but they can include computed or derived values (not just user-provided inputs).\n# locals.tf - Define reusable values and computed tags\r# `locals {` starts the block\rlocals {\r# Common tags to apply to all resources\r# Defines a reusable map of tags\rcommon_tags = {\rProject = var.project_name\rEnvironment = var.environment\rManagedBy = \"Terraform\"\rCreatedAt = timestamp() # Computed at runtime using current runtime stamp\r}\r# Resource naming convention\r# Useful for consistent resource names or tags across environments\rname_prefix = \"${var.project_name}-${var.environment}\"\r# Computed values\r# These locals make it easier to refer to the values without repeating longer expressions\rvpc_cidr = var.vpc_cidr # references the variable block\rregion = data.aws_region.current.name # references the data block\r} Explanation:\nDefines local values to standardize instance naming across the configuration. Can apply the local.common_tags to all taggable resources, ensuring consistency across infrastructure. Code consistency (single place to define tag maps or name patterns) Maintainability (change once, propagate everywhere) Readability (clear, descriptive references) main.tf This is the core infrastructure definition file in Terraform. It contains all the resource blocks to define and build AWS network, security, compute resources, logging, and permissions.\nKey sections explained:\nVPC Creation resource \"aws_vpc\" \"main\" {\rcidr_block = var.vpc_cidr\renable_dns_hostnames = var.enable_dns_hostnames\renable_dns_support = var.enable_dns_support\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-vpc\"\r})\r} Creates a new VPC using the specified CIDR block and DNS settings. Applies consistent tags merged from local common tags. Internet Gateway resource \"aws_internet_gateway\" \"main\" {\rvpc_id = aws_vpc.main.id\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-igw\"\r})\r} Attaches an internet gateway to the new VPC, enabling internet access for public resources. Subnets # Create public subnet\rresource \"aws_subnet\" \"public\" {\rvpc_id = aws_vpc.main.id\rcidr_block = var.public_subnet_cidr\ravailability_zone = var.availability_zone\rmap_public_ip_on_launch = true\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-public-subnet\"\rType = \"Public\"\r})\r}\r# Create private subnet\rresource \"aws_subnet\" \"private\" {\rvpc_id = aws_vpc.main.id\rcidr_block = var.private_subnet_cidr\ravailability_zone = var.availability_zone\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-private-subnet\"\rType = \"Private\"\r})\r} Creates a public subnet and a private subnet in the specified availability zone. The public subnet allows public IP assignments; the private one does not. Elastic IP and NAT Gateway # Allocate Elastic IP for NAT Gateway\rresource \"aws_eip\" \"nat\" {\rdomain = \"vpc\"\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-nat-eip\"\r})\rdepends_on = [aws_internet_gateway.main]\r}\r# Create NAT Gateway in public subnet\rresource \"aws_nat_gateway\" \"nat\" {\rallocation_id = aws_eip.nat.id\rsubnet_id = aws_subnet.public.id\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-nat-gateway\"\r})\rdepends_on = [aws_internet_gateway.main]\r} Allocates a static Elastic IP and attaches it to a NAT Gateway in the public subnet, allowing private subnet instances to access the internet outbound. Route Tables # Create public route table\rresource \"aws_route_table\" \"public\" {\rvpc_id = aws_vpc.main.id\rroute {\rcidr_block = \"0.0.0.0/0\"\rgateway_id = aws_internet_gateway.main.id\r}\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-public-rt\"\rType = \"Public\"\r})\r}\r# Associate public route table with public subnet\rresource \"aws_route_table_association\" \"public_assoc\" {\rsubnet_id = aws_subnet.public.id\rroute_table_id = aws_route_table.public.id\r}\r# Create private route table (via NAT Gateway)\rresource \"aws_route_table\" \"private\" {\rvpc_id = aws_vpc.main.id # Changed from data.aws_vpc.existing.id\rroute {\rcidr_block = \"0.0.0.0/0\"\rnat_gateway_id = aws_nat_gateway.nat.id\r}\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-private-rt\"\rType = \"Private\"\r})\r}\r# Associate private route table with private subnet\rresource \"aws_route_table_association\" \"private_assoc\" {\rsubnet_id = aws_subnet.private.id\rroute_table_id = aws_route_table.private.id\r} Creates a public route table with a default route to the internet gateway.\nCreates a private route table with a default route to the NAT gateway.\nAssociates the correct route table with each subnet.\nSecurity Groups # Create Security Group for public EC2\rresource \"aws_security_group\" \"public_sg\" {\rname_prefix = \"${local.name_prefix}-public-\"\rdescription = \"Security group for public EC2 instances - allows SSH from specified IP\"\rvpc_id = aws_vpc.main.id\ringress {\rdescription = \"SSH from home IP\"\rfrom_port = 22\rto_port = 22\rprotocol = \"tcp\"\rcidr_blocks = [var.home_ip]\r}\regress {\rdescription = \"All outbound traffic\"\rfrom_port = 0\rto_port = 0\rprotocol = \"-1\"\rcidr_blocks = [\"0.0.0.0/0\"]\r}\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-public-sg\"\rType = \"Public\"\r})\rlifecycle {\rcreate_before_destroy = true\r}\r}\r# Create Security Group for private EC2\rresource \"aws_security_group\" \"private_sg\" {\rname_prefix = \"${local.name_prefix}-private-\"\rdescription = \"Security group for private EC2 instances - allows SSH from public subnet\"\rvpc_id = aws_vpc.main.id\ringress {\rdescription = \"SSH from public subnet\"\rfrom_port = 22\rto_port = 22\rprotocol = \"tcp\"\rsecurity_groups = [aws_security_group.public_sg.id]\r}\regress {\rdescription = \"All outbound traffic\"\rfrom_port = 0\rto_port = 0\rprotocol = \"-1\"\rcidr_blocks = [\"0.0.0.0/0\"]\r}\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-private-sg\"\rType = \"Private\"\r})\rlifecycle {\rcreate_before_destroy = true\r}\r} Public SG allows SSH access only from the specified home IP.\nPrivate SG allows SSH access only from the public instance SG (used as a bastion host).\nEC2 Instances # Launch EC2 in public subnet\rresource \"aws_instance\" \"public_ec2\" {\rami = data.aws_ami.amazon_linux.id\rinstance_type = var.instance_type\rsubnet_id = aws_subnet.public.id\rkey_name = var.key_name\rvpc_security_group_ids = [aws_security_group.public_sg.id]\ruser_data = base64encode(templatefile(\"${path.module}/user-data/public-userdata.sh\", {\rhostname = \"${local.name_prefix}-public\"\r}))\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-public-ec2\"\rType = \"Public\"\rRole = \"Bastion\"\r})\r}\r# Launch EC2 in private subnet\rresource \"aws_instance\" \"private_ec2\" {\rami = data.aws_ami.amazon_linux.id\rinstance_type = var.instance_type\rsubnet_id = aws_subnet.private.id\rkey_name = var.key_name\rvpc_security_group_ids = [aws_security_group.private_sg.id]\ruser_data = base64encode(templatefile(\"${path.module}/user-data/private-userdata.sh\", {\rhostname = \"${local.name_prefix}-private\"\r}))\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-private-ec2\"\rType = \"Private\"\rRole = \"Backend\"\r})\r} Launches an EC2 instance in the public subnet (Amazon Linux 2), serving as a bastion or jump host.\nLaunches an EC2 instance in the private subnet (Amazon Linux 2), serving as a backend node.\nBoth use user data scripts (public-userdata.sh, private-userdata.sh) and consistent tagging.\nCloudWatch Log Group for VPC Flow Logs # Create CloudWatch Log Group for VPC Flow Logs\rresource \"aws_cloudwatch_log_group\" \"vpc_logs\" {\rname = \"/aws/vpc/flowlogs/${local.name_prefix}\"\rretention_in_days = 7\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-vpc-flow-logs\"\r})\r} Creates a CloudWatch log group to hold the VPC Flow Logs, with a 7-day retention period. IAM Role and Policy for VPC Flow Logs # Create IAM role for flow logs\rresource \"aws_iam_role\" \"flow_logs_role\" {\rname_prefix = \"${local.name_prefix}-flow-logs-\"\rassume_role_policy = jsonencode({\rVersion = \"2012-10-17\",\rStatement = [{\rAction = \"sts:AssumeRole\",\rEffect = \"Allow\",\rPrincipal = {\rService = \"vpc-flow-logs.amazonaws.com\"\r}\r}]\r})\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-flow-logs-role\"\r})\r}\r# Create custom IAM policy for flow logs\rresource \"aws_iam_role_policy\" \"flow_logs_policy\" {\rname_prefix = \"${local.name_prefix}-flow-logs-\"\rrole = aws_iam_role.flow_logs_role.id\rpolicy = jsonencode({\rVersion = \"2012-10-17\",\rStatement = [\r{\rEffect = \"Allow\",\rAction = [\r\"logs:CreateLogStream\",\r\"logs:PutLogEvents\",\r\"logs:DescribeLogGroups\",\r\"logs:DescribeLogStreams\"\r],\rResource = \"${aws_cloudwatch_log_group.vpc_logs.arn}:*\"\r}\r]\r})\r} Creates an IAM role with permissions for VPC Flow Logs to push data to CloudWatch Logs. Enable VPC Flow Logs # Enable VPC Flow Logs\rresource \"aws_flow_log\" \"vpc_flow_logs\" {\rlog_destination_type = \"cloud-watch-logs\"\rlog_destination = aws_cloudwatch_log_group.vpc_logs.arn\rtraffic_type = \"ALL\"\rvpc_id = aws_vpc.main.id # Changed from data.aws_vpc.existing.id\riam_role_arn = aws_iam_role.flow_logs_role.arn\rtags = merge(local.common_tags, {\rName = \"${local.name_prefix}-vpc-flow-logs\"\r})\r} Enables detailed traffic logging on the VPC, writing all traffic data (accepted and rejected) to CloudWatch Logs. Explanation:\nUses locals for consistent naming and tags. Applies merge patterns for reusable tag blocks. Includes lifecycle rules (like create_before_destroy) for safer updates. outputs.tf The outputs.tf file defines what Terraform will print after terraform apply finishes. This helps to get key resource, IDs, IPs, and metadata. It makes it easier to connect or interact with deployed resources. It can also feed outputs into other Terraform modules or systems.\n# outputs.tf\r# Outputs VPC Information\r# Useful for confirming network foundation and account context\routput \"vpc_info\" {\rdescription = \"Information about the created VPC\"\rvalue = {\rvpc_id = aws_vpc.main.id vpc_cidr = aws_vpc.main.cidr_block igw_id = aws_internet_gateway.main.id\rregion = data.aws_region.current.name\raccount_id = data.aws_caller_identity.current.account_id\r}\r}\r# Outputs Subnet Information\r# Helps verify where subnets landed\routput \"subnet_info\" {\rdescription = \"Information about created subnets\"\rvalue = {\rpublic_subnet = {\rid = aws_subnet.public.id\rcidr_block = aws_subnet.public.cidr_block\raz = aws_subnet.public.availability_zone\r}\rprivate_subnet = {\rid = aws_subnet.private.id\rcidr_block = aws_subnet.private.cidr_block\raz = aws_subnet.private.availability_zone\r}\r}\r}\r# Outputs Security Group Information\r# Useful to reference or modify SGs later\routput \"security_group_info\" {\rdescription = \"Information about created security groups\"\rvalue = {\rpublic_sg_id = aws_security_group.public_sg.id\rprivate_sg_id = aws_security_group.private_sg.id\r}\r}\r# Outputs EC2 Instance Information\r# Critical for connecting, troubleshooting, or automating follow-up tasks\routput \"instance_info\" {\rdescription = \"Information about EC2 instances\"\rvalue = {\rpublic_instance = {\rid = aws_instance.public_ec2.id\rpublic_ip = aws_instance.public_ec2.public_ip\rprivate_ip = aws_instance.public_ec2.private_ip\rami_id = aws_instance.public_ec2.ami\r}\rprivate_instance = {\rid = aws_instance.private_ec2.id\rprivate_ip = aws_instance.private_ec2.private_ip\rami_id = aws_instance.private_ec2.ami\r}\r}\r}\r# Outputs NAT Gateway Information\r# Helps confirm NAT setup and outbound address\routput \"nat_gateway_info\" {\rdescription = \"Information about NAT Gateway\"\rvalue = {\rnat_gateway_id = aws_nat_gateway.nat.id\relastic_ip = aws_eip.nat.public_ip\r}\r}\r# Outputs VPC Flow Logs Information\r# Useful to pull logs, configure alerts, or analyze traffic\routput \"flow_logs_info\" {\rdescription = \"Information about VPC Flow Logs\"\rvalue = {\rlog_group_name = aws_cloudwatch_log_group.vpc_logs.name\rlog_group_arn = aws_cloudwatch_log_group.vpc_logs.arn\r}\r}\r# Outputs SSH Command Shortcuts\r# Improves usability, especially for fast testing or handover\routput \"ssh_commands\" {\rdescription = \"SSH commands to connect to instances\"\rvalue = {\rpublic_instance = \"ssh -i ~/.ssh/${var.key_name}.pem ec2-user@${aws_instance.public_ec2.public_ip}\"\rprivate_instance = \"ssh -i ~/.ssh/${var.key_name}.pem -o ProxyJump=ec2-user@${aws_instance.public_ec2.public_ip} ec2-user@${aws_instance.private_ec2.private_ip}\"\r}\r} Explanation:\nWell-organized and grouped outputs. Includes useful operational details (IPs, IDs, names) Provides ready-to-use SSH access tips Possible Improvements\nAdd sensitive = true to hide any sensitive values (like internal IPs or commands) from Terraform CLI output. Provide outputs formatted as maps or lists. Will be useful for scaling to multiple instances or subnets. Deployment Workflow Utilizing Terraform Commands Initialize the Terraform project:\nterraform init Format the configuration:\nterraform fmt Validate the configuration:\nterraform validate Review the execution plan:\nterraform plan Apply the configuration to deploy resources:\nterraform apply When finished, clean up resources:\nterraform destroy Deployment Workflow Utilizing PowerShell Script This script is designed to automate and safeguard the Terraform deployment workflow. It ensures prerequisites, verifies configuration, assists the user, and executes Terraform commands in a structured, safe order.\n# Terraform Deployment Script # ========================================== # 1. PREREQUISITES CHECK # ========================================== Write-Host \"Checking Terraform installation...\" -ForegroundColor Yellow terraform --version if ($LASTEXITCODE -ne 0) { Write-Host \"ERROR: Terraform not found! Install from: https://www.terraform.io/downloads\" -ForegroundColor Red exit 1 } Write-Host \"Checking AWS CLI...\" -ForegroundColor Yellow aws --version if ($LASTEXITCODE -ne 0) { Write-Host \"ERROR: AWS CLI not found! Install from: https://aws.amazon.com/cli/\" -ForegroundColor Red exit 1 } Write-Host \"Checking AWS credentials...\" -ForegroundColor Yellow aws sts get-caller-identity if ($LASTEXITCODE -ne 0) { Write-Host \"ERROR: AWS credentials not configured! Run: aws configure\" -ForegroundColor Red exit 1 } # ========================================== # 2. PROJECT SETUP # ========================================== Write-Host \"Checking project directory...\" -ForegroundColor Yellow $CurrentDir = Split-Path -Leaf (Get-Location) Write-Host \"Current directory: $CurrentDir\" -ForegroundColor Green # Go up one level if we're in user-data directory if ($CurrentDir -eq \"user-data\") { Set-Location \"..\" $CurrentDir = Split-Path -Leaf (Get-Location) Write-Host \"Moved up to: $CurrentDir\" -ForegroundColor Green } # Verify Terraform files exist $TerraformFiles = @(\"main.tf\", \"variables.tf\", \"outputs.tf\", \"provider.tf\", \"data.tf\", \"locals.tf\") $MissingFiles = @() foreach ($file in $TerraformFiles) { if (-not (Test-Path $file)) { $MissingFiles += $file } } if ($MissingFiles.Count -gt 0) { Write-Host \"ERROR: Missing Terraform files: $($MissingFiles -join ', ')\" -ForegroundColor Red Write-Host \"Make sure you're in the correct directory with your .tf files!\" -ForegroundColor Red exit 1 } Write-Host \"SUCCESS: All Terraform files found\" -ForegroundColor Green # Check if terraform.tfvars exists if (-not (Test-Path \"terraform.tfvars\")) { Write-Host \"Creating terraform.tfvars template...\" -ForegroundColor Yellow $TerraformVars = @\" # terraform.tfvars - Customize these values for your environment # Required variables (you MUST set these) key_name = \"your-key-pair-name\" # Replace with your EC2 key pair name home_ip = \"203.0.113.1/32\" # Replace with your public IP + /32 # Optional customizations project_name = \"tillynet-vpc-lab\" environment = \"dev\" vpc_cidr = \"10.0.0.0/16\" public_subnet_cidr = \"10.0.1.0/24\" private_subnet_cidr = \"10.0.2.0/24\" availability_zone = \"us-west-1a\" instance_type = \"t2.micro\" # DNS settings enable_dns_hostnames = true enable_dns_support = true \"@ $TerraformVars | Out-File -FilePath \"terraform.tfvars\" -Encoding UTF8 Write-Host \"SUCCESS: Created terraform.tfvars template\" -ForegroundColor Green Write-Host \"IMPORTANT: Edit terraform.tfvars with your actual values before proceeding!\" -ForegroundColor Red } # Check user-data directory if (-not (Test-Path \"user-data\")) { Write-Host \"ERROR: user-data directory not found!\" -ForegroundColor Red exit 1 } $UserDataFiles = @(\"user-data/public-userdata.sh\", \"user-data/private-userdata.sh\") foreach ($file in $UserDataFiles) { if (-not (Test-Path $file)) { Write-Host \"ERROR: Missing user-data script: $file\" -ForegroundColor Red exit 1 } } Write-Host \"SUCCESS: User-data scripts found\" -ForegroundColor Green # ========================================== # 3. GET PUBLIC IP # ========================================== Write-Host \"Getting your public IP address...\" -ForegroundColor Yellow try { $PublicIP = (Invoke-RestMethod -Uri \"https://ifconfig.me/ip\" -TimeoutSec 10).Trim() Write-Host \"SUCCESS: Your public IP: $PublicIP\" -ForegroundColor Green Write-Host \"Make sure terraform.tfvars has: home_ip = `\"$PublicIP/32`\"\" -ForegroundColor Cyan # Check if terraform.tfvars needs updating $TfVarsContent = Get-Content \"terraform.tfvars\" -Raw if ($TfVarsContent -match \"203\\.0\\.113\\.1/32\") { Write-Host \"WARNING: terraform.tfvars still has placeholder IP - update it!\" -ForegroundColor Yellow } } catch { Write-Host \"ERROR: Could not get public IP. Get it from: https://whatismyipaddress.com/\" -ForegroundColor Red } # ========================================== # 4. TERRAFORM DEPLOYMENT # ========================================== Write-Host \"`nSTARTING TERRAFORM DEPLOYMENT\" -ForegroundColor Magenta Write-Host \"======================================\" -ForegroundColor Magenta # Function to run Terraform commands function Invoke-TerraformCommand { param( [string]$Command, [string]$Description ) Write-Host \"`n$Description\" -ForegroundColor Yellow Write-Host \"Running: terraform $Command\" -ForegroundColor Gray $StartTime = Get-Date Invoke-Expression \"terraform $Command\" $EndTime = Get-Date $Duration = $EndTime - $StartTime if ($LASTEXITCODE -eq 0) { Write-Host \"SUCCESS: $Description completed (took $($Duration.TotalSeconds) seconds)\" -ForegroundColor Green return $true } else { Write-Host \"ERROR: $Description failed!\" -ForegroundColor Red Write-Host \"Check the output above for error details.\" -ForegroundColor Red return $false } } # Pre-deployment validation Write-Host \"`nValidating configuration...\" -ForegroundColor Yellow $TfVarsContent = Get-Content \"terraform.tfvars\" -Raw if ($TfVarsContent -match \"your-key-pair-name\") { Write-Host \"ERROR: terraform.tfvars still has placeholder key_name!\" -ForegroundColor Red Write-Host \"Create a key pair in AWS Console: EC2 -\u003e Key Pairs -\u003e Create\" -ForegroundColor Yellow exit 1 } # Step 1: Initialize if (-not (Invoke-TerraformCommand \"init\" \"Initializing Terraform\")) { exit 1 } # Step 2: Validate if (-not (Invoke-TerraformCommand \"validate\" \"Validating Terraform configuration\")) { exit 1 } # Step 3: Format Invoke-TerraformCommand \"fmt\" \"Formatting Terraform code\" # Step 4: Plan Write-Host \"`nCreating Terraform plan...\" -ForegroundColor Yellow Write-Host \"This shows what resources will be created (NEW VPC + subnets + EC2s).\" -ForegroundColor Gray if (-not (Invoke-TerraformCommand \"plan -out=tfplan\" \"Planning deployment\")) { exit 1 } # Step 5: Confirm Write-Host \"`nReady to deploy infrastructure?\" -ForegroundColor Yellow Write-Host \"This will create a NEW VPC with all resources (NAT Gateway costs about $32/month).\" -ForegroundColor Red Write-Host \"Resources to be created:\" -ForegroundColor Cyan Write-Host \"- New VPC (10.0.0.0/16)\" -ForegroundColor White Write-Host \"- Internet Gateway\" -ForegroundColor White Write-Host \"- Public and Private Subnets\" -ForegroundColor White Write-Host \"- NAT Gateway (about $32/month)\" -ForegroundColor White Write-Host \"- 2 EC2 instances (t2.micro - free tier)\" -ForegroundColor White Write-Host \"- Security Groups, Route Tables, VPC Flow Logs\" -ForegroundColor White $Confirmation = Read-Host \"Type 'yes' to proceed with deployment\" if ($Confirmation -eq \"yes\") { # Step 6: Apply if (Invoke-TerraformCommand \"apply tfplan\" \"Applying Terraform plan\") { Write-Host \"`nDEPLOYMENT SUCCESSFUL!\" -ForegroundColor Green Write-Host \"======================================\" -ForegroundColor Green # Show outputs Write-Host \"`nInfrastructure Details:\" -ForegroundColor Cyan terraform output # Cleanup Remove-Item \"tfplan\" -ErrorAction SilentlyContinue Write-Host \"`nNext Steps:\" -ForegroundColor Yellow Write-Host \"1. Check AWS Console to see created resources\" -ForegroundColor White Write-Host \"2. Use SSH commands from output to connect to instances\" -ForegroundColor White Write-Host \"3. Test connectivity: Public -\u003e Private instance\" -ForegroundColor White Write-Host \"4. When done testing, run: terraform destroy\" -ForegroundColor White Write-Host \"`nUseful AWS Console Links:\" -ForegroundColor Yellow Write-Host \"- VPC Dashboard: https://console.aws.amazon.com/vpc/\" -ForegroundColor White Write-Host \"- EC2 Dashboard: https://console.aws.amazon.com/ec2/\" -ForegroundColor White Write-Host \"- CloudWatch Logs: https://console.aws.amazon.com/cloudwatch/\" -ForegroundColor White } } else { Write-Host \"Deployment cancelled by user.\" -ForegroundColor Red Remove-Item \"tfplan\" -ErrorAction SilentlyContinue } # ========================================== # 5. HELPFUL COMMANDS # ========================================== Write-Host \"`nUSEFUL TERRAFORM COMMANDS:\" -ForegroundColor Magenta Write-Host \"======================================\" -ForegroundColor Magenta Write-Host \"terraform show # Show current state\" -ForegroundColor White Write-Host \"terraform output # Show outputs again\" -ForegroundColor White Write-Host \"terraform state list # List all resources\" -ForegroundColor White Write-Host \"terraform plan # Plan changes\" -ForegroundColor White Write-Host \"terraform apply # Apply changes\" -ForegroundColor White Write-Host \"terraform destroy # Delete all resources\" -ForegroundColor White Write-Host \"`nTROUBLESHOOTING:\" -ForegroundColor Magenta Write-Host \"======================================\" -ForegroundColor Magenta Write-Host \"- Error about credentials: Run 'aws configure'\" -ForegroundColor White Write-Host \"- Error about regions: Check availability_zone variable\" -ForegroundColor White Write-Host \"- Error about key pairs: Create key pair in EC2 console first\" -ForegroundColor White Write-Host \"- Error about permissions: Ensure your AWS user has admin rights\" -ForegroundColor White Write-Host \"`nDeployment script completed!\" -ForegroundColor Green 1. Prerequisite Checks Checks if:\nTerraform is installed (terraform --version) AWS CLI is installed (aws --version) AWS CLI credentials are configured (aws sts get-caller-identity) If any of these checks fail, the script exits early to prevent wasted runs.\nPrevents runtime errors later by confirming the local environment is ready. 2. Project Directory Setup Checks if you’re inside the terraform-vpc-lab directory. If you’re in the user-data subfolder, moves up one level. Verifies critical Terraform files are present (main.tf, variables.tf, etc.). Creates a terraform.tfvars template if it doesn’t exist, reminding the user to fill in actual values. Prevents mistakes from running Terraform in the wrong folder or with missing config.\n3. Public IP Check Retrieves the users current public IP using an external API https://ifconfig.me/ip. Alerts if the placeholder 203.0.113.1/32 is still in your terraform.tfvars. Ensures Security Group home_ip is set properly thus allowing SSH in.\n4. Terraform Deployment Steps Uses a helper function Invoke-TerraformCommand that:\nRuns a Terraform command.\nTracks execution time.\nChecks success or failure.\nProvides colorful, clear user feedback.\nCommands it runs in sequence:\nterraform init → initializes backend + providers.\nterraform validate → checks configuration syntax.\nterraform fmt → formats the Terraform code.\nterraform plan -out=tfplan → creates an executable plan file.\nPrompts the user:\nExplicit user confirmation before applying. terraform apply tfplan → deploys the infrastructure.\nAfter apply:\nShows terraform output.\nCleans up the tfplan file.\nLists helpful AWS console links.\nAutomates best practices and reduces human error in the apply phase.\n5. Helpful Commands + Troubleshooting At the end, it prints:\nCommon Terraform CLI commands for post-deployment work.\nTroubleshooting tips for:\nCredential issues\nRegion mismatches\nKey pair errors\nPermissions problems\nGives the user guidance on what to do after deployment or if something goes wrong.\nWhy Utilize PowerShell Deployment Clear, user-friendly feedback using color and prompts. Safety checks to prevent misconfigured runs. Scripted generation of tfvars template to help beginners. Modular Terraform command function for reusability. Includes time tracking and success/failure detection. Potential Improvements Add error handling for:\nNetwork timeouts when fetching public IP. terraform command not found inside restricted environments. Support for custom -var-file input if multiple environments (dev, prod). Support an optional terraform destroy flag or mode for teardown automation. Log output to a file for post-run audit. Best Practices and Notes Use environment variables or terraform.tfvars to avoid hardcoding sensitive values (like your home IP) in .tf files.\nAlways run terraform plan before apply to review changes.\nEnsure your AMI IDs are up-to-date for your target region.\nKeep .tfstate files secure, especially when using sensitive outputs.\nUse .gitignore to exclude sensitive files if committing the project to version control.\n",
  "wordCount" : "4315",
  "inLanguage": "en",
  "datePublished": "2025-05-27T00:00:00Z",
  "dateModified": "2025-05-27T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.tillynet.com/cloud-engineering-labs/aws-lab-1/aws-cloud-security-lab-summary-terraform-project/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Tilly Net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.tillynet.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.tillynet.com/" accesskey="h" title="Tilly Net (Alt + H)">Tilly Net</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.tillynet.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/on-premise-engineering-labs/" title="On-Premise Engineering Labs">
                    <span>On-Premise Engineering Labs</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/cloud-engineering-labs" title="Cloud Engineering Labs">
                    <span>Cloud Engineering Labs</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      AWS Cloud Security Deployment - Terraform
    </h1>
    <div class="post-meta"><span title='2025-05-27 00:00:00 +0000 UTC'>May 27, 2025</span>&nbsp;·&nbsp;21 min

</div>
  </header> 
  <div class="post-content"><h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<p>This document summarizes the technical work completed today to build, configure, and automate a secure AWS VPC lab using Terraform. It covers manual and automated infrastructure steps, with detailed explanations for each Terraform configuration component, designed to help replicate the setup at any time in the future.</p>
<hr>
<h2 id="objectives">Objectives<a hidden class="anchor" aria-hidden="true" href="#objectives">#</a></h2>
<ul>
<li>
<p>Build a segmented AWS VPC network with public and private subnets.</p>
</li>
<li>
<p>Launch EC2 instances in both public and private subnets.</p>
</li>
<li>
<p>Secure access using Security Groups.</p>
</li>
<li>
<p>Enable VPC Flow Logs for traffic monitoring.</p>
</li>
<li>
<p>Manage the infrastructure using Terraform, with variables and data sources referencing existing AWS resources.</p>
</li>
</ul>
<hr>
<h2 id="prerequisites">Prerequisites<a hidden class="anchor" aria-hidden="true" href="#prerequisites">#</a></h2>
<ul>
<li>
<p>An AWS Free Tier account.</p>
</li>
<li>
<p>AWS CLI installed and configured (<code>aws configure</code>) with IAM user access keys.</p>
</li>
<li>
<p>Terraform installed on the local workstation.</p>
</li>
<li>
<p>An existing VPC created manually in AWS.</p>
</li>
<li>
<p>An EC2 SSH Key Pair created in AWS (with the <code>.pem</code> file downloaded and stored securely).</p>
</li>
</ul>
<hr>
<h2 id="terraform-project-structure">Terraform Project Structure<a hidden class="anchor" aria-hidden="true" href="#terraform-project-structure">#</a></h2>
<pre tabindex="0"><code>/terraform-vpc-lab
  ├── provider.tf
  ├── variables.tf
  ├── data.tf
  ├── locals.tf
  ├── main.tf
  ├── outputs.tf
  ├── terraform.tfvars
  └── user-data
	  ├── deploy-terraform.ps1
	  ├── private-userdata.sh
	  └── public-userdata.sh
</code></pre><p>Each file has a specific purpose, described in detail below.</p>
<hr>
<h2 id="providertf">provider.tf<a hidden class="anchor" aria-hidden="true" href="#providertf">#</a></h2>
<pre tabindex="0"><code>provider &#34;aws&#34; {
  region = &#34;us-east-1&#34;
}
</code></pre><p><strong>Explanation:</strong></p>
<ul>
<li>
<p>Defines the AWS provider Terraform will use.</p>
</li>
<li>
<p>Sets the default AWS region to <code>us-west-1</code>. This can be adjusted or turned into a configurable variable if needed.</p>
</li>
</ul>
<hr>
<h2 id="variablestf">variables.tf<a hidden class="anchor" aria-hidden="true" href="#variablestf">#</a></h2>
<p>The variables.tf file defines <strong>all the input variables</strong> your Terraform configuration uses, making it:</p>
<ul>
<li>Flexible</li>
<li>Resusable</li>
<li>Easier to manage across environments (dev, staging, prod)
By declaring variables here we avoid hardcoding values in <code>main.tf</code> or other resource files.</li>
</ul>
<pre tabindex="0"><code># variables.tf - defines and validates variables
variable &#34;vpc_cidr&#34; {
  description = &#34;CIDR block for the new VPC&#34;
  type        = string
  default     = &#34;10.0.0.0/16&#34;
  
  validation {
    condition     = can(cidrhost(var.vpc_cidr, 0))
    error_message = &#34;VPC CIDR must be a valid IPv4 CIDR block.&#34;
  }
}

# defines which AWS Availability zone to deploy into
variable &#34;availability_zone&#34; {
  description = &#34;The AWS Availability Zone&#34;
  type        = string
  default     = &#34;us-west-1a&#34;

# regex validation to ensure the format matches AWS AZ patterns
  validation {
    condition     = can(regex(&#34;^[a-z]{2}-[a-z]+-[0-9][a-z]$&#34;, var.availability_zone))
    error_message = &#34;Availability zone must be in the format like &#39;us-west-1a&#39;.&#34;
  }
}

# Defines the IP range for the public subnet
variable &#34;public_subnet_cidr&#34; {
  description = &#34;CIDR block for the public subnet&#34;
  type        = string
  default     = &#34;10.0.1.0/24&#34;

# CIDR validation check
  validation {
    condition     = can(cidrhost(var.public_subnet_cidr, 0))
    error_message = &#34;Public subnet CIDR must be a valid IPv4 CIDR block.&#34;
  }
}

# Defines the IP range for the private subnet
variable &#34;private_subnet_cidr&#34; {
  description = &#34;CIDR block for the private subnet&#34;
  type        = string
  default     = &#34;10.0.2.0/24&#34;

# CIDR validation check
  validation {
    condition     = can(cidrhost(var.private_subnet_cidr, 0))
    error_message = &#34;Private subnet CIDR must be a valid IPv4 CIDR block.&#34;
  }
}

# Specifies the name of the EC2 SSH key pair used for connecting to instances.
variable &#34;key_name&#34; {
  description = &#34;The name of the EC2 SSH key pair&#34;
  type        = string
}

# Used in security group rules to restrict SSH access
# requires a /32 CIDR notation
variable &#34;home_ip&#34; {
  description = &#34;Your home public IP address with /32 mask (e.g., 203.0.113.1/32)&#34;
  type        = string

# Regex validation to ensure proper format
  validation {
    condition     = can(regex(&#34;^([0-9]{1,3}\\.){3}[0-9]{1,3}/32$&#34;, var.home_ip))
    error_message = &#34;Home IP must be a valid IPv4 address with /32 mask (e.g., 203.0.113.1/32).&#34;
  }
}

# Used for tagging AWS resources for identification
# Helps track whick resources belong to whick project
variable &#34;project_name&#34; {
  description = &#34;Name of the project for resource tagging&#34;
  type        = string
  default     = &#34;terraform-vpc-demo&#34;
}

# Tags resources or configures settings per environment
variable &#34;environment&#34; {
  description = &#34;Environment name (dev, staging, prod)&#34;
  type        = string
  default     = &#34;dev&#34;

# Ensures only use valid environment names
  validation {
    condition     = contains([&#34;dev&#34;, &#34;staging&#34;, &#34;prod&#34;], var.environment)
    error_message = &#34;Environment must be one of: dev, staging, prod.&#34;
  }
}

# Controls the size of the EC2 instances
# Below is freet-tier eligible
variable &#34;instance_type&#34; {
  description = &#34;EC2 instance type&#34;
  type        = string
  default     = &#34;t2.micro&#34;
}

# Controls whether DNS hostnames is enabled for the VPC
# Belowis set to true - best practice
variable &#34;enable_dns_hostnames&#34; {
  description = &#34;Enable DNS hostnames in the VPC&#34;
  type        = bool
  default     = true
}

# Controls whether DNS support is enabled for the VPC
# Below set to true - best practice
variable &#34;enable_dns_support&#34; {
  description = &#34;Enable DNS support in the VPC&#34;
  type        = bool
  default     = true
}
</code></pre><p><strong>Explanation:</strong></p>
<ul>
<li>Defines all required input variables, including the VPC, subnet CIDRs, key pair name, and the home public IP address for secure SSH access.</li>
<li>Modular and adaptable to different setups.</li>
<li>Safter through built-in validation blocks.</li>
<li>Easier to manage across environments by externalizing critical settings.</li>
</ul>
<hr>
<h2 id="terraformtfvars">terraform.tfvars<a hidden class="anchor" aria-hidden="true" href="#terraformtfvars">#</a></h2>
<pre tabindex="0"><code># terraform.tfvars - define sensitive values
key_name            = &#34;AWS_key_name&#34;
home_ip             = &#34;publicIP/32&#34;
project_name        = &#34;project name&#34;
environment         = &#34;dev&#34;
vpc_cidr            = &#34;10.0.0.0/16&#34;
public_subnet_cidr  = &#34;10.0.1.0/24&#34;
private_subnet_cidr = &#34;10.0.2.0/24&#34;
availability_zone   = &#34;us-west-1a&#34;
instance_type       = &#34;t2.micro&#34;
</code></pre><p><strong>Explanation:</strong></p>
<ul>
<li>
<p>Provides actual values for the variables defined in <code>variables.tf</code>.</p>
</li>
<li>
<p>This file is automatically loaded by Terraform and should be excluded from version control for sensitive values.</p>
</li>
</ul>
<hr>
<h2 id="datatf">data.tf<a hidden class="anchor" aria-hidden="true" href="#datatf">#</a></h2>
<p>This file defines Terraform data sources, which allows the ability to query AWS for existing dynamic information that is not created or managed directly, such as available regions, caller identity, AMI IDs, or availability zones.</p>
<p>These values can be used throughout Terraform configurations for dynamic, up-to-date references.</p>
<pre tabindex="0"><code># data.tf - Centralize data sources
# Fetches the AWS region that Terraform is currently operating in
# Useful to reference the region dynamically in resources or outputs without hardcoding var.region everwhere
data &#34;aws_region&#34; &#34;current&#34; {}

# Returns details about the active AWS identity: AWS account ID, Amazon Resource Name (ARN), User ID
# Useful for tagging, auditing, or conditional logic tied to the current account
data &#34;aws_caller_identity&#34; &#34;current&#34; {}

# Returns a list of available AZs in the current region
# Can be used to distribute resources across zones for HA
# below is only including AZs in the &#34;available&#34; state
data &#34;aws_availability_zones&#34; &#34;available&#34; {
  state = &#34;available&#34;
}

# Looks up the most recent official Amazon Linux 2 AMI
# Ensures that EC2 instances are always built from the latest Amazon-maintained AMI, reducing the need to hardcode AMI IDs
data &#34;aws_ami&#34; &#34;amazon_linux&#34; {
  most_recent = true
  owners      = [&#34;amazon&#34;]
  
  filter {
    name   = &#34;name&#34;
    values = [&#34;amzn2-ami-hvm-*-x86_64-gp2&#34;] # HVM-based, general-purpose SSD, 64-bit
  }
  
  filter {
    name   = &#34;virtualization-type&#34; # sets virtualization type to HVM
    values = [&#34;hvm&#34;]
  }
}
</code></pre><p><strong>Explanation:</strong></p>
<ul>
<li>Uses Terraform&rsquo;s <code>data</code> sources to reference existing AWS resources without Terraform managing or creating them.</li>
<li>Makes Terraform configuration more dynamic and adaptable.</li>
<li>Reduce hardcoding of values that might change between regions, accounts, or over time.</li>
<li>Help ensure that the infrastructure always targets the correct, most up-to-date AWS resources.</li>
</ul>
<hr>
<h2 id="localstf">locals.tf<a hidden class="anchor" aria-hidden="true" href="#localstf">#</a></h2>
<p>The <code>locals</code> block in Terrraform defines <strong>computed values</strong> or <strong>constants</strong> that can be reused throughout the configuration. The <strong>computed values</strong> and <strong>constants</strong> help reduce repetition, centralize logic, and make configurations easier to maintain. These are like reusable variables, but they can include computed or derived values (not just user-provided inputs).</p>
<pre tabindex="0"><code># locals.tf - Define reusable values and computed tags
# `locals {` starts the block
locals {
  # Common tags to apply to all resources
  # Defines a reusable map of tags
  common_tags = {
    Project     = var.project_name
    Environment = var.environment
    ManagedBy   = &#34;Terraform&#34;
    CreatedAt   = timestamp() # Computed at runtime using current runtime stamp
  }

  # Resource naming convention
  # Useful for consistent resource names or tags across environments
  name_prefix = &#34;${var.project_name}-${var.environment}&#34;
  
  # Computed values
  # These locals make it easier to refer to the values without repeating longer expressions
  vpc_cidr = var.vpc_cidr                 # references the variable block
  region   = data.aws_region.current.name # references the data block
}
</code></pre><p><strong>Explanation:</strong></p>
<ul>
<li>Defines local values to standardize instance naming across the configuration.</li>
<li>Can apply the <code>local.common_tags</code> to all taggable resources, ensuring consistency across infrastructure.</li>
<li>Code consistency (single place to define tag maps or name patterns)</li>
<li>Maintainability (change once, propagate everywhere)</li>
<li>Readability (clear, descriptive references)</li>
</ul>
<hr>
<h2 id="maintf">main.tf<a hidden class="anchor" aria-hidden="true" href="#maintf">#</a></h2>
<p>This is the <strong>core infrastructure definition</strong> file in Terraform. It contains all the resource blocks to define and build AWS network, security, compute resources, logging, and permissions.</p>
<p><strong>Key sections explained:</strong></p>
<h3 id="vpc-creation">VPC Creation<a hidden class="anchor" aria-hidden="true" href="#vpc-creation">#</a></h3>
<pre tabindex="0"><code>resource &#34;aws_vpc&#34; &#34;main&#34; {
  cidr_block           = var.vpc_cidr
  enable_dns_hostnames = var.enable_dns_hostnames
  enable_dns_support   = var.enable_dns_support
  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-vpc&#34;
  })
}
</code></pre><ul>
<li>Creates a new VPC using the specified CIDR block and DNS settings.</li>
<li>Applies consistent tags merged from local common tags.</li>
</ul>
<h3 id="internet-gateway">Internet Gateway<a hidden class="anchor" aria-hidden="true" href="#internet-gateway">#</a></h3>
<pre tabindex="0"><code>resource &#34;aws_internet_gateway&#34; &#34;main&#34; {
  vpc_id = aws_vpc.main.id
  tags   = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-igw&#34;
  })
}
</code></pre><ul>
<li>Attaches an internet gateway to the new VPC, enabling internet access for public resources.</li>
</ul>
<h3 id="subnets">Subnets<a hidden class="anchor" aria-hidden="true" href="#subnets">#</a></h3>
<pre tabindex="0"><code># Create public subnet
resource &#34;aws_subnet&#34; &#34;public&#34; {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = var.public_subnet_cidr
  availability_zone       = var.availability_zone
  map_public_ip_on_launch = true
  
  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-public-subnet&#34;
    Type = &#34;Public&#34;
  })
}
  
# Create private subnet
resource &#34;aws_subnet&#34; &#34;private&#34; {
  vpc_id            = aws_vpc.main.id
  cidr_block        = var.private_subnet_cidr
  availability_zone = var.availability_zone
  
  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-private-subnet&#34;
    Type = &#34;Private&#34;
  })
}
</code></pre><ul>
<li>Creates a public subnet and a private subnet in the specified availability zone.</li>
<li>The public subnet allows public IP assignments; the private one does not.</li>
</ul>
<h3 id="elastic-ip-and-nat-gateway">Elastic IP and NAT Gateway<a hidden class="anchor" aria-hidden="true" href="#elastic-ip-and-nat-gateway">#</a></h3>
<pre tabindex="0"><code># Allocate Elastic IP for NAT Gateway
resource &#34;aws_eip&#34; &#34;nat&#34; {
  domain = &#34;vpc&#34;
  
  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-nat-eip&#34;
  })

  depends_on = [aws_internet_gateway.main]
}
  
# Create NAT Gateway in public subnet
resource &#34;aws_nat_gateway&#34; &#34;nat&#34; {
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public.id

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-nat-gateway&#34;
  })

  depends_on = [aws_internet_gateway.main]
}
</code></pre><ul>
<li>Allocates a static Elastic IP and attaches it to a NAT Gateway in the public subnet, allowing private subnet instances to access the internet outbound.</li>
</ul>
<h3 id="route-tables">Route Tables<a hidden class="anchor" aria-hidden="true" href="#route-tables">#</a></h3>
<pre tabindex="0"><code># Create public route table
resource &#34;aws_route_table&#34; &#34;public&#34; {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = &#34;0.0.0.0/0&#34;
    gateway_id = aws_internet_gateway.main.id
  }

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-public-rt&#34;
    Type = &#34;Public&#34;
  })
}

# Associate public route table with public subnet
resource &#34;aws_route_table_association&#34; &#34;public_assoc&#34; {
  subnet_id      = aws_subnet.public.id
  route_table_id = aws_route_table.public.id
}

# Create private route table (via NAT Gateway)
resource &#34;aws_route_table&#34; &#34;private&#34; {
  vpc_id = aws_vpc.main.id # Changed from data.aws_vpc.existing.id

  route {
    cidr_block     = &#34;0.0.0.0/0&#34;
    nat_gateway_id = aws_nat_gateway.nat.id
  }

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-private-rt&#34;
    Type = &#34;Private&#34;
  })
}

# Associate private route table with private subnet
resource &#34;aws_route_table_association&#34; &#34;private_assoc&#34; {
  subnet_id      = aws_subnet.private.id
  route_table_id = aws_route_table.private.id
}
</code></pre><ul>
<li>
<p>Creates a public route table with a default route to the internet gateway.</p>
</li>
<li>
<p>Creates a private route table with a default route to the NAT gateway.</p>
</li>
<li>
<p>Associates the correct route table with each subnet.</p>
</li>
</ul>
<h3 id="security-groups">Security Groups<a hidden class="anchor" aria-hidden="true" href="#security-groups">#</a></h3>
<pre tabindex="0"><code># Create Security Group for public EC2
resource &#34;aws_security_group&#34; &#34;public_sg&#34; {
  name_prefix = &#34;${local.name_prefix}-public-&#34;
  description = &#34;Security group for public EC2 instances - allows SSH from specified IP&#34;
  vpc_id      = aws_vpc.main.id
  
  ingress {
    description = &#34;SSH from home IP&#34;
    from_port   = 22
    to_port     = 22
    protocol    = &#34;tcp&#34;
    cidr_blocks = [var.home_ip]
  }

  egress {
    description = &#34;All outbound traffic&#34;
    from_port   = 0
    to_port     = 0
    protocol    = &#34;-1&#34;
    cidr_blocks = [&#34;0.0.0.0/0&#34;]
  }

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-public-sg&#34;
    Type = &#34;Public&#34;
  })

  lifecycle {
    create_before_destroy = true
  }
}

# Create Security Group for private EC2
resource &#34;aws_security_group&#34; &#34;private_sg&#34; {
  name_prefix = &#34;${local.name_prefix}-private-&#34;
  description = &#34;Security group for private EC2 instances - allows SSH from public subnet&#34;
  vpc_id      = aws_vpc.main.id

  ingress {
    description     = &#34;SSH from public subnet&#34;
    from_port       = 22
    to_port         = 22
    protocol        = &#34;tcp&#34;
    security_groups = [aws_security_group.public_sg.id]
  }

  egress {
    description = &#34;All outbound traffic&#34;
    from_port   = 0
    to_port     = 0
    protocol    = &#34;-1&#34;
    cidr_blocks = [&#34;0.0.0.0/0&#34;]
  }

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-private-sg&#34;
    Type = &#34;Private&#34;
  })

  lifecycle {
    create_before_destroy = true
  }
}
</code></pre><ul>
<li>
<p>Public SG allows SSH access only from the specified home IP.</p>
</li>
<li>
<p>Private SG allows SSH access only from the public instance SG (used as a bastion host).</p>
</li>
</ul>
<h3 id="ec2-instances">EC2 Instances<a hidden class="anchor" aria-hidden="true" href="#ec2-instances">#</a></h3>
<pre tabindex="0"><code># Launch EC2 in public subnet
resource &#34;aws_instance&#34; &#34;public_ec2&#34; {
  ami                    = data.aws_ami.amazon_linux.id
  instance_type          = var.instance_type
  subnet_id              = aws_subnet.public.id
  key_name               = var.key_name
  vpc_security_group_ids = [aws_security_group.public_sg.id]

  user_data = base64encode(templatefile(&#34;${path.module}/user-data/public-userdata.sh&#34;, {
    hostname = &#34;${local.name_prefix}-public&#34;
  }))

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-public-ec2&#34;
    Type = &#34;Public&#34;
    Role = &#34;Bastion&#34;
  })
}

# Launch EC2 in private subnet
resource &#34;aws_instance&#34; &#34;private_ec2&#34; {
  ami                    = data.aws_ami.amazon_linux.id
  instance_type          = var.instance_type
  subnet_id              = aws_subnet.private.id
  key_name               = var.key_name

  vpc_security_group_ids = [aws_security_group.private_sg.id]

  user_data = base64encode(templatefile(&#34;${path.module}/user-data/private-userdata.sh&#34;, {
    hostname = &#34;${local.name_prefix}-private&#34;
  }))

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-private-ec2&#34;
    Type = &#34;Private&#34;
    Role = &#34;Backend&#34;
  })
}
</code></pre><ul>
<li>
<p>Launches an EC2 instance in the public subnet (Amazon Linux 2), serving as a bastion or jump host.</p>
</li>
<li>
<p>Launches an EC2 instance in the private subnet (Amazon Linux 2), serving as a backend node.</p>
</li>
<li>
<p>Both use user data scripts (<code>public-userdata.sh</code>, <code>private-userdata.sh</code>) and consistent tagging.</p>
</li>
</ul>
<h3 id="cloudwatch-log-group-for-vpc-flow-logs">CloudWatch Log Group for VPC Flow Logs<a hidden class="anchor" aria-hidden="true" href="#cloudwatch-log-group-for-vpc-flow-logs">#</a></h3>
<pre tabindex="0"><code># Create CloudWatch Log Group for VPC Flow Logs
resource &#34;aws_cloudwatch_log_group&#34; &#34;vpc_logs&#34; {
  name              = &#34;/aws/vpc/flowlogs/${local.name_prefix}&#34;
  retention_in_days = 7

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-vpc-flow-logs&#34;
  })
}
</code></pre><ul>
<li>Creates a CloudWatch log group to hold the VPC Flow Logs, with a 7-day retention period.</li>
</ul>
<h3 id="iam-role-and-policy-for-vpc-flow-logs">IAM Role and Policy for VPC Flow Logs<a hidden class="anchor" aria-hidden="true" href="#iam-role-and-policy-for-vpc-flow-logs">#</a></h3>
<pre tabindex="0"><code># Create IAM role for flow logs
resource &#34;aws_iam_role&#34; &#34;flow_logs_role&#34; {
  name_prefix = &#34;${local.name_prefix}-flow-logs-&#34;

  assume_role_policy = jsonencode({
    Version = &#34;2012-10-17&#34;,
    Statement = [{
      Action = &#34;sts:AssumeRole&#34;,
      Effect = &#34;Allow&#34;,
      Principal = {
        Service = &#34;vpc-flow-logs.amazonaws.com&#34;
      }
    }]
  })

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-flow-logs-role&#34;
  })
}

  

# Create custom IAM policy for flow logs
resource &#34;aws_iam_role_policy&#34; &#34;flow_logs_policy&#34; {
  name_prefix = &#34;${local.name_prefix}-flow-logs-&#34;
  role        = aws_iam_role.flow_logs_role.id

  policy = jsonencode({
    Version = &#34;2012-10-17&#34;,
    Statement = [
      {
        Effect = &#34;Allow&#34;,
        Action = [
          &#34;logs:CreateLogStream&#34;,
          &#34;logs:PutLogEvents&#34;,
          &#34;logs:DescribeLogGroups&#34;,
          &#34;logs:DescribeLogStreams&#34;
        ],
        Resource = &#34;${aws_cloudwatch_log_group.vpc_logs.arn}:*&#34;
      }
    ]
  })
}
</code></pre><ul>
<li>Creates an IAM role with permissions for VPC Flow Logs to push data to CloudWatch Logs.</li>
</ul>
<h3 id="enable-vpc-flow-logs">Enable VPC Flow Logs<a hidden class="anchor" aria-hidden="true" href="#enable-vpc-flow-logs">#</a></h3>
<pre tabindex="0"><code># Enable VPC Flow Logs
resource &#34;aws_flow_log&#34; &#34;vpc_flow_logs&#34; {
  log_destination_type = &#34;cloud-watch-logs&#34;
  log_destination      = aws_cloudwatch_log_group.vpc_logs.arn
  traffic_type         = &#34;ALL&#34;
  vpc_id               = aws_vpc.main.id # Changed from data.aws_vpc.existing.id
  iam_role_arn         = aws_iam_role.flow_logs_role.arn

  tags = merge(local.common_tags, {
    Name = &#34;${local.name_prefix}-vpc-flow-logs&#34;
  })
}
</code></pre><ul>
<li>Enables detailed traffic logging on the VPC, writing all traffic data (accepted and rejected) to CloudWatch Logs.</li>
</ul>
<p><strong>Explanation:</strong></p>
<ul>
<li>Uses <code>locals</code> for consistent naming and tags.</li>
<li>Applies merge patterns for reusable tag blocks.</li>
<li>Includes lifecycle rules (like create_before_destroy) for safer updates.</li>
</ul>
<hr>
<h2 id="outputstf">outputs.tf<a hidden class="anchor" aria-hidden="true" href="#outputstf">#</a></h2>
<p>The <code>outputs.tf</code> file defines what Terraform will print after <code>terraform apply</code> finishes. This helps to get key resource, IDs, IPs, and metadata. It makes it easier to connect or interact with deployed resources. It can also feed outputs into other Terraform modules or systems.</p>
<pre tabindex="0"><code># outputs.tf

# Outputs VPC Information
# Useful for confirming network foundation and account context
output &#34;vpc_info&#34; {
  description = &#34;Information about the created VPC&#34;
  value = {
    vpc_id     = aws_vpc.main.id              
    vpc_cidr   = aws_vpc.main.cidr_block      
    igw_id     = aws_internet_gateway.main.id
    region     = data.aws_region.current.name
    account_id = data.aws_caller_identity.current.account_id
  }
}

# Outputs Subnet Information
# Helps verify where subnets landed
output &#34;subnet_info&#34; {
  description = &#34;Information about created subnets&#34;
  value = {
    public_subnet = {
      id         = aws_subnet.public.id
      cidr_block = aws_subnet.public.cidr_block
      az         = aws_subnet.public.availability_zone
    }
    private_subnet = {
      id         = aws_subnet.private.id
      cidr_block = aws_subnet.private.cidr_block
      az         = aws_subnet.private.availability_zone
    }
  }
}

# Outputs Security Group Information
# Useful to reference or modify SGs later
output &#34;security_group_info&#34; {
  description = &#34;Information about created security groups&#34;
  value = {
    public_sg_id  = aws_security_group.public_sg.id
    private_sg_id = aws_security_group.private_sg.id
  }
}

# Outputs EC2 Instance Information
# Critical for connecting, troubleshooting, or automating follow-up tasks
output &#34;instance_info&#34; {
  description = &#34;Information about EC2 instances&#34;
  value = {
    public_instance = {
      id         = aws_instance.public_ec2.id
      public_ip  = aws_instance.public_ec2.public_ip
      private_ip = aws_instance.public_ec2.private_ip
      ami_id     = aws_instance.public_ec2.ami
    }
    private_instance = {
      id         = aws_instance.private_ec2.id
      private_ip = aws_instance.private_ec2.private_ip
      ami_id     = aws_instance.private_ec2.ami
    }
  }
}

# Outputs NAT Gateway Information
# Helps confirm NAT setup and outbound address
output &#34;nat_gateway_info&#34; {
  description = &#34;Information about NAT Gateway&#34;
  value = {
    nat_gateway_id = aws_nat_gateway.nat.id
    elastic_ip     = aws_eip.nat.public_ip
  }
}

# Outputs VPC Flow Logs Information
# Useful to pull logs, configure alerts, or analyze traffic
output &#34;flow_logs_info&#34; {

  description = &#34;Information about VPC Flow Logs&#34;
  value = {
    log_group_name = aws_cloudwatch_log_group.vpc_logs.name
    log_group_arn  = aws_cloudwatch_log_group.vpc_logs.arn
  }
}

# Outputs SSH Command Shortcuts
# Improves usability, especially for fast testing or handover
output &#34;ssh_commands&#34; {
  description = &#34;SSH commands to connect to instances&#34;
  value = {
    public_instance  = &#34;ssh -i ~/.ssh/${var.key_name}.pem ec2-user@${aws_instance.public_ec2.public_ip}&#34;
    private_instance = &#34;ssh -i ~/.ssh/${var.key_name}.pem -o ProxyJump=ec2-user@${aws_instance.public_ec2.public_ip} ec2-user@${aws_instance.private_ec2.private_ip}&#34;
  }
}
</code></pre><p><strong>Explanation:</strong></p>
<ul>
<li>Well-organized and grouped outputs.</li>
<li>Includes useful operational details (IPs, IDs, names)</li>
<li>Provides ready-to-use SSH access tips</li>
</ul>
<p><strong>Possible Improvements</strong></p>
<ul>
<li>Add sensitive = true to hide any sensitive values (like internal IPs or commands) from Terraform CLI output.</li>
<li>Provide outputs formatted as maps or lists. Will be useful for scaling to multiple instances or subnets.</li>
</ul>
<hr>
<h2 id="deployment-workflow-utilizing-terraform-commands">Deployment Workflow Utilizing Terraform Commands<a hidden class="anchor" aria-hidden="true" href="#deployment-workflow-utilizing-terraform-commands">#</a></h2>
<ol>
<li>
<p>Initialize the Terraform project:</p>
<pre tabindex="0"><code>terraform init
</code></pre></li>
<li>
<p>Format the configuration:</p>
<pre tabindex="0"><code>terraform fmt
</code></pre></li>
<li>
<p>Validate the configuration:</p>
<pre tabindex="0"><code>terraform validate
</code></pre></li>
<li>
<p>Review the execution plan:</p>
<pre tabindex="0"><code>terraform plan
</code></pre></li>
<li>
<p>Apply the configuration to deploy resources:</p>
<pre tabindex="0"><code>terraform apply
</code></pre></li>
<li>
<p>When finished, clean up resources:</p>
<pre tabindex="0"><code>terraform destroy
</code></pre></li>
</ol>
<hr>
<h2 id="deployment-workflow-utilizing-powershell-script">Deployment Workflow Utilizing PowerShell Script<a hidden class="anchor" aria-hidden="true" href="#deployment-workflow-utilizing-powershell-script">#</a></h2>
<p>This script is designed to automate and safeguard the Terraform deployment workflow. It ensures prerequisites, verifies configuration, assists the user, and executes Terraform commands in a structured, safe order.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Terraform Deployment Script</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl"><span class="c"># 1. PREREQUISITES CHECK</span>
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Checking Terraform installation...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="n">terraform</span> <span class="p">-</span><span class="n">-version</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$LASTEXITCODE</span> <span class="o">-ne</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: Terraform not found! Install from: https://www.terraform.io/downloads&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Checking AWS CLI...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="n">aws</span> <span class="p">-</span><span class="n">-version</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$LASTEXITCODE</span> <span class="o">-ne</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: AWS CLI not found! Install from: https://aws.amazon.com/cli/&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Checking AWS credentials...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="n">aws</span> <span class="n">sts</span> <span class="nb">get-caller</span><span class="n">-identity</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$LASTEXITCODE</span> <span class="o">-ne</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: AWS credentials not configured! Run: aws configure&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl"><span class="c"># 2. PROJECT SETUP</span>
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Checking project directory...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CurrentDir</span> <span class="p">=</span> <span class="nb">Split-Path</span> <span class="n">-Leaf</span> <span class="p">(</span><span class="nb">Get-Location</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Current directory: </span><span class="nv">$CurrentDir</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Go up one level if we&#39;re in user-data directory</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$CurrentDir</span> <span class="o">-eq</span> <span class="s2">&#34;user-data&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Set-Location</span> <span class="s2">&#34;..&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$CurrentDir</span> <span class="p">=</span> <span class="nb">Split-Path</span> <span class="n">-Leaf</span> <span class="p">(</span><span class="nb">Get-Location</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Moved up to: </span><span class="nv">$CurrentDir</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Verify Terraform files exist</span>
</span></span><span class="line"><span class="cl"><span class="nv">$TerraformFiles</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;main.tf&#34;</span><span class="p">,</span> <span class="s2">&#34;variables.tf&#34;</span><span class="p">,</span> <span class="s2">&#34;outputs.tf&#34;</span><span class="p">,</span> <span class="s2">&#34;provider.tf&#34;</span><span class="p">,</span> <span class="s2">&#34;data.tf&#34;</span><span class="p">,</span> <span class="s2">&#34;locals.tf&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$MissingFiles</span> <span class="p">=</span> <span class="vm">@</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$file</span> <span class="k">in</span> <span class="nv">$TerraformFiles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$MissingFiles</span> <span class="p">+=</span> <span class="nv">$file</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$MissingFiles</span><span class="p">.</span><span class="py">Count</span> <span class="o">-gt</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: Missing Terraform files: </span><span class="p">$(</span><span class="nv">$MissingFiles</span> <span class="n">-join</span> <span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Make sure you&#39;re in the correct directory with your .tf files!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;SUCCESS: All Terraform files found&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c"># Check if terraform.tfvars exists</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;terraform.tfvars&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Creating terraform.tfvars template...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$TerraformVars</span> <span class="p">=</span> <span class="sh">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh"># terraform.tfvars - Customize these values for your environment
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh"># Required variables (you MUST set these)
</span></span></span><span class="line"><span class="cl"><span class="sh">key_name = &#34;your-key-pair-name&#34;              # Replace with your EC2 key pair name
</span></span></span><span class="line"><span class="cl"><span class="sh">home_ip  = &#34;203.0.113.1/32&#34;                 # Replace with your public IP + /32
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh"># Optional customizations
</span></span></span><span class="line"><span class="cl"><span class="sh">project_name         = &#34;tillynet-vpc-lab&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">environment         = &#34;dev&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">vpc_cidr            = &#34;10.0.0.0/16&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">public_subnet_cidr  = &#34;10.0.1.0/24&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">private_subnet_cidr = &#34;10.0.2.0/24&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">availability_zone   = &#34;us-west-1a&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">instance_type       = &#34;t2.micro&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">
</span></span></span><span class="line"><span class="cl"><span class="sh"># DNS settings
</span></span></span><span class="line"><span class="cl"><span class="sh">enable_dns_hostnames = true
</span></span></span><span class="line"><span class="cl"><span class="sh">enable_dns_support   = true
</span></span></span><span class="line"><span class="cl"><span class="sh">&#34;@</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$TerraformVars</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="s2">&#34;terraform.tfvars&#34;</span> <span class="n">-Encoding</span> <span class="n">UTF8</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;SUCCESS: Created terraform.tfvars template&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;IMPORTANT: Edit terraform.tfvars with your actual values before proceeding!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Check user-data directory</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="s2">&#34;user-data&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: user-data directory not found!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$UserDataFiles</span> <span class="p">=</span> <span class="vm">@</span><span class="p">(</span><span class="s2">&#34;user-data/public-userdata.sh&#34;</span><span class="p">,</span> <span class="s2">&#34;user-data/private-userdata.sh&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$file</span> <span class="k">in</span> <span class="nv">$UserDataFiles</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: Missing user-data script: </span><span class="nv">$file</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;SUCCESS: User-data scripts found&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl"><span class="c"># 3. GET PUBLIC IP</span>
</span></span><span class="line"><span class="cl"><span class="c"># ========================================== </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Getting your public IP address...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$PublicIP</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&#34;https://ifconfig.me/ip&#34;</span> <span class="n">-TimeoutSec</span> <span class="mf">10</span><span class="p">).</span><span class="py">Trim</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;SUCCESS: Your public IP: </span><span class="nv">$PublicIP</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Make sure terraform.tfvars has: home_ip = </span><span class="se">`&#34;</span><span class="nv">$PublicIP</span><span class="s2">/32</span><span class="se">`&#34;</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c"># Check if terraform.tfvars needs updating</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$TfVarsContent</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="s2">&#34;terraform.tfvars&#34;</span> <span class="n">-Raw</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$TfVarsContent</span> <span class="o">-match</span> <span class="s2">&#34;203\.0\.113\.1/32&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;WARNING: terraform.tfvars still has placeholder IP - update it!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: Could not get public IP. Get it from: https://whatismyipaddress.com/&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl"><span class="c"># 4. TERRAFORM DEPLOYMENT</span>
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">STARTING TERRAFORM DEPLOYMENT&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;======================================&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Function to run Terraform commands</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">Invoke-TerraformCommand</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">param</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">string</span><span class="p">]</span><span class="nv">$Command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="no">string</span><span class="p">]</span><span class="nv">$Description</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="nv">$Description</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Running: terraform </span><span class="nv">$Command</span><span class="s2">&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nv">$StartTime</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Invoke-Expression</span> <span class="s2">&#34;terraform </span><span class="nv">$Command</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$EndTime</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$Duration</span> <span class="p">=</span> <span class="nv">$EndTime</span> <span class="p">-</span> <span class="nv">$StartTime</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$LASTEXITCODE</span> <span class="o">-eq</span> <span class="mf">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;SUCCESS: </span><span class="nv">$Description</span><span class="s2"> completed (took </span><span class="p">$(</span><span class="nv">$Duration</span><span class="p">.</span><span class="n">TotalSeconds</span><span class="p">)</span><span class="s2"> seconds)&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="vm">$true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: </span><span class="nv">$Description</span><span class="s2"> failed!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;Check the output above for error details.&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="vm">$false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Pre-deployment validation</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">Validating configuration...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="nv">$TfVarsContent</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="s2">&#34;terraform.tfvars&#34;</span> <span class="n">-Raw</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$TfVarsContent</span> <span class="o">-match</span> <span class="s2">&#34;your-key-pair-name&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;ERROR: terraform.tfvars still has placeholder key_name!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Create a key pair in AWS Console: EC2 -&gt; Key Pairs -&gt; Create&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Step 1: Initialize</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Invoke-TerraformCommand</span> <span class="s2">&#34;init&#34;</span> <span class="s2">&#34;Initializing Terraform&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c"># Step 2: Validate</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Invoke-TerraformCommand</span> <span class="s2">&#34;validate&#34;</span> <span class="s2">&#34;Validating Terraform configuration&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Step 3: Format</span>
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-TerraformCommand</span> <span class="s2">&#34;fmt&#34;</span> <span class="s2">&#34;Formatting Terraform code&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Step 4: Plan</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">Creating Terraform plan...&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;This shows what resources will be created (NEW VPC + subnets + EC2s).&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Gray</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Invoke-TerraformCommand</span> <span class="s2">&#34;plan -out=tfplan&#34;</span> <span class="s2">&#34;Planning deployment&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Step 5: Confirm</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">Ready to deploy infrastructure?&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;This will create a NEW VPC with all resources (NAT Gateway costs about </span><span class="nv">$32</span><span class="s2">/month).&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Resources to be created:&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- New VPC (10.0.0.0/16)&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- Internet Gateway&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- Public and Private Subnets&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- NAT Gateway (about </span><span class="nv">$32</span><span class="s2">/month)&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- 2 EC2 instances (t2.micro - free tier)&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- Security Groups, Route Tables, VPC Flow Logs&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$Confirmation</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&#34;Type &#39;yes&#39; to proceed with deployment&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$Confirmation</span> <span class="o">-eq</span> <span class="s2">&#34;yes&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c"># Step 6: Apply</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">Invoke-TerraformCommand</span> <span class="s2">&#34;apply tfplan&#34;</span> <span class="s2">&#34;Applying Terraform plan&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">DEPLOYMENT SUCCESSFUL!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;======================================&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c"># Show outputs</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">Infrastructure Details:&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
</span></span><span class="line"><span class="cl">        <span class="n">terraform</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c"># Cleanup</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Remove-Item</span> <span class="s2">&#34;tfplan&#34;</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">Next Steps:&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;1. Check AWS Console to see created resources&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;2. Use SSH commands from output to connect to instances&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;3. Test connectivity: Public -&gt; Private instance&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;4. When done testing, run: terraform destroy&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">Useful AWS Console Links:&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;- VPC Dashboard: https://console.aws.amazon.com/vpc/&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;- EC2 Dashboard: https://console.aws.amazon.com/ec2/&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Host</span> <span class="s2">&#34;- CloudWatch Logs: https://console.aws.amazon.com/cloudwatch/&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Host</span> <span class="s2">&#34;Deployment cancelled by user.&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Remove-Item</span> <span class="s2">&#34;tfplan&#34;</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl"><span class="c"># 5. HELPFUL COMMANDS</span>
</span></span><span class="line"><span class="cl"><span class="c"># ==========================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">USEFUL TERRAFORM COMMANDS:&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;======================================&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;terraform show           # Show current state&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;terraform output         # Show outputs again&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;terraform state list     # List all resources&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;terraform plan           # Plan changes&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;terraform apply          # Apply changes&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;terraform destroy        # Delete all resources&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">TROUBLESHOOTING:&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;======================================&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- Error about credentials: Run &#39;aws configure&#39;&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- Error about regions: Check availability_zone variable&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- Error about key pairs: Create key pair in EC2 console first&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;- Error about permissions: Ensure your AWS user has admin rights&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">White</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`n</span><span class="s2">Deployment script completed!&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span></code></pre></div><h3 id="1-prerequisite-checks">1. Prerequisite Checks<a hidden class="anchor" aria-hidden="true" href="#1-prerequisite-checks">#</a></h3>
<p>Checks if:</p>
<ul>
<li>Terraform is installed (<code>terraform --version</code>)</li>
<li>AWS CLI is installed (<code>aws --version</code>)</li>
<li>AWS CLI credentials are configured (<code>aws sts get-caller-identity</code>)</li>
</ul>
<p>If any of these checks fail, the script exits early to prevent wasted runs.</p>
<ul>
<li>Prevents runtime errors later by confirming the local environment is ready.</li>
</ul>
<h3 id="2-project-directory-setup">2. Project Directory Setup<a hidden class="anchor" aria-hidden="true" href="#2-project-directory-setup">#</a></h3>
<ul>
<li>Checks if you’re inside the <code>terraform-vpc-lab</code> directory.</li>
<li>If you’re in the <code>user-data</code> subfolder, moves up one level.</li>
<li>Verifies critical Terraform files are present (<code>main.tf</code>, <code>variables.tf</code>, etc.).</li>
<li>Creates a <code>terraform.tfvars</code> template if it doesn’t exist, reminding the user to fill in actual values.</li>
</ul>
<p>Prevents mistakes from running Terraform in the wrong folder or with missing config.</p>
<h3 id="3-public-ip-check">3. Public IP Check<a hidden class="anchor" aria-hidden="true" href="#3-public-ip-check">#</a></h3>
<ul>
<li>Retrieves the users current public IP using an external API <code>https://ifconfig.me/ip</code>.</li>
<li>Alerts if the placeholder <code>203.0.113.1/32</code> is still in your <code>terraform.tfvars</code>.</li>
</ul>
<p>Ensures Security Group <code>home_ip</code> is set properly thus allowing SSH in.</p>
<h3 id="4-terraform-deployment-steps">4. Terraform Deployment Steps<a hidden class="anchor" aria-hidden="true" href="#4-terraform-deployment-steps">#</a></h3>
<p>Uses a helper function <code>Invoke-TerraformCommand</code> that:</p>
<ul>
<li>
<p>Runs a Terraform command.</p>
</li>
<li>
<p>Tracks execution time.</p>
</li>
<li>
<p>Checks success or failure.</p>
</li>
<li>
<p>Provides colorful, clear user feedback.</p>
</li>
</ul>
<p>Commands it runs in sequence:</p>
<ol>
<li>
<p><code>terraform init</code> → initializes backend + providers.</p>
</li>
<li>
<p><code>terraform validate</code> → checks configuration syntax.</p>
</li>
<li>
<p><code>terraform fmt</code> → formats the Terraform code.</p>
</li>
<li>
<p><code>terraform plan -out=tfplan</code> → creates an executable plan file.</p>
</li>
<li>
<p>Prompts the user:</p>
<ul>
<li>Explicit user confirmation before applying.</li>
</ul>
</li>
<li>
<p><code>terraform apply tfplan</code> → deploys the infrastructure.</p>
</li>
<li>
<p>After apply:</p>
<ul>
<li>
<p>Shows <code>terraform output</code>.</p>
</li>
<li>
<p>Cleans up the <code>tfplan</code> file.</p>
</li>
<li>
<p>Lists helpful AWS console links.</p>
</li>
</ul>
</li>
</ol>
<p>Automates best practices and reduces human error in the apply phase.</p>
<h3 id="5-helpful-commands--troubleshooting">5. Helpful Commands + Troubleshooting<a hidden class="anchor" aria-hidden="true" href="#5-helpful-commands--troubleshooting">#</a></h3>
<p>At the end, it prints:</p>
<ul>
<li>
<p>Common Terraform CLI commands for post-deployment work.</p>
</li>
<li>
<p>Troubleshooting tips for:</p>
<ul>
<li>
<p>Credential issues</p>
</li>
<li>
<p>Region mismatches</p>
</li>
<li>
<p>Key pair errors</p>
</li>
<li>
<p>Permissions problems</p>
</li>
</ul>
</li>
</ul>
<p>Gives the user guidance on what to do after deployment or if something goes wrong.</p>
<h3 id="why-utilize-powershell-deployment">Why Utilize PowerShell Deployment<a hidden class="anchor" aria-hidden="true" href="#why-utilize-powershell-deployment">#</a></h3>
<ul>
<li>Clear, user-friendly feedback using color and prompts.</li>
<li>Safety checks to prevent misconfigured runs.</li>
<li>Scripted generation of tfvars template to help beginners.</li>
<li>Modular Terraform command function for reusability.</li>
<li>Includes time tracking and success/failure detection.</li>
</ul>
<h3 id="potential-improvements">Potential Improvements<a hidden class="anchor" aria-hidden="true" href="#potential-improvements">#</a></h3>
<p>Add error handling for:</p>
<ul>
<li>Network timeouts when fetching public IP.</li>
<li><code>terraform</code> command not found inside restricted environments.</li>
<li>Support for custom -var-file input if multiple environments (dev, prod).</li>
<li>Support an optional <code>terraform destroy</code> flag or mode for teardown automation.</li>
<li>Log output to a file for post-run audit.</li>
</ul>
<hr>
<h2 id="best-practices-and-notes">Best Practices and Notes<a hidden class="anchor" aria-hidden="true" href="#best-practices-and-notes">#</a></h2>
<ul>
<li>
<p>Use environment variables or <code>terraform.tfvars</code> to avoid hardcoding sensitive values (like your home IP) in <code>.tf</code> files.</p>
</li>
<li>
<p>Always run <code>terraform plan</code> before <code>apply</code> to review changes.</p>
</li>
<li>
<p>Ensure your AMI IDs are up-to-date for your target region.</p>
</li>
<li>
<p>Keep <code>.tfstate</code> files secure, especially when using sensitive outputs.</p>
</li>
<li>
<p>Use <code>.gitignore</code> to exclude sensitive files if committing the project to version control.</p>
</li>
</ul>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.tillynet.com/tags/aws/">Aws</a></li>
      <li><a href="https://blog.tillynet.com/tags/ec2/">Ec2</a></li>
      <li><a href="https://blog.tillynet.com/tags/vpc/">Vpc</a></li>
      <li><a href="https://blog.tillynet.com/tags/bastion/">Bastion</a></li>
      <li><a href="https://blog.tillynet.com/tags/jumpbox/">Jumpbox</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://blog.tillynet.com/on-premise-engineering-labs/building-a-proper-pki-chain-of-trust-in-a-samba-ad-lab/">
    <span class="title">Next »</span>
    <br>
    <span>Building a Proper PKI Chain of Trust in a Samba AD Lab</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://blog.tillynet.com/">Tilly Net</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
