<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Building a Secure Hybrid Cloud Infrastructure with AWS VPN and DNS Integration | Tilly Net</title>
<meta name="keywords" content="AWS, On-Premise, Hybrid, Cloud, Route, DNS, Samba4, EC2, Bastion, VPC, VPN, IPsec, terraform, PfSense, infrastructure-as-code, network, automation, cloud, deployment">
<meta name="description" content="Overview
This post documents my journey building a production-grade hybrid cloud infrastructure that securely connects my on-premises homelab environment with AWS. The implementation demonstrates enterprise-level network segmentation, DNS integration, and security practices using Infrastructure as Code (IaC) principles.
Architecture Goals
My primary objectives were to:

Establish secure connectivity between on-premises and AWS environments
Implement seamless DNS resolution across both environments
Maintain security isolation while enabling necessary communication
Use Infrastructure as Code for reproducible deployments
Follow enterprise best practices for hybrid cloud architectures

On-Premises Infrastructure Overview
My existing homelab infrastructure includes:">
<meta name="author" content="">
<link rel="canonical" href="https://blog.tillynet.com/cloud-engineering-labs/aws-lab-4/building-a-secure-hybrid-cloud-infrastructure-with-aws-vpn-and-dns-integration/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.tillynet.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.tillynet.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.tillynet.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.tillynet.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.tillynet.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://blog.tillynet.com/cloud-engineering-labs/aws-lab-4/building-a-secure-hybrid-cloud-infrastructure-with-aws-vpn-and-dns-integration/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://blog.tillynet.com/cloud-engineering-labs/aws-lab-4/building-a-secure-hybrid-cloud-infrastructure-with-aws-vpn-and-dns-integration/">
  <meta property="og:site_name" content="Tilly Net">
  <meta property="og:title" content="Building a Secure Hybrid Cloud Infrastructure with AWS VPN and DNS Integration">
  <meta property="og:description" content="Overview This post documents my journey building a production-grade hybrid cloud infrastructure that securely connects my on-premises homelab environment with AWS. The implementation demonstrates enterprise-level network segmentation, DNS integration, and security practices using Infrastructure as Code (IaC) principles.
Architecture Goals My primary objectives were to:
Establish secure connectivity between on-premises and AWS environments Implement seamless DNS resolution across both environments Maintain security isolation while enabling necessary communication Use Infrastructure as Code for reproducible deployments Follow enterprise best practices for hybrid cloud architectures On-Premises Infrastructure Overview My existing homelab infrastructure includes:">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="cloud-engineering-labs">
    <meta property="article:published_time" content="2025-06-04T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-06-04T00:00:00+00:00">
    <meta property="article:tag" content="AWS">
    <meta property="article:tag" content="On-Premise">
    <meta property="article:tag" content="Hybrid">
    <meta property="article:tag" content="Route">
    <meta property="article:tag" content="Dns">
    <meta property="article:tag" content="Samba4">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Building a Secure Hybrid Cloud Infrastructure with AWS VPN and DNS Integration">
<meta name="twitter:description" content="Overview
This post documents my journey building a production-grade hybrid cloud infrastructure that securely connects my on-premises homelab environment with AWS. The implementation demonstrates enterprise-level network segmentation, DNS integration, and security practices using Infrastructure as Code (IaC) principles.
Architecture Goals
My primary objectives were to:

Establish secure connectivity between on-premises and AWS environments
Implement seamless DNS resolution across both environments
Maintain security isolation while enabling necessary communication
Use Infrastructure as Code for reproducible deployments
Follow enterprise best practices for hybrid cloud architectures

On-Premises Infrastructure Overview
My existing homelab infrastructure includes:">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Cloud-Engineering-Labs",
      "item": "https://blog.tillynet.com/cloud-engineering-labs/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Building a Secure Hybrid Cloud Infrastructure with AWS VPN and DNS Integration",
      "item": "https://blog.tillynet.com/cloud-engineering-labs/aws-lab-4/building-a-secure-hybrid-cloud-infrastructure-with-aws-vpn-and-dns-integration/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Building a Secure Hybrid Cloud Infrastructure with AWS VPN and DNS Integration",
  "name": "Building a Secure Hybrid Cloud Infrastructure with AWS VPN and DNS Integration",
  "description": "Overview This post documents my journey building a production-grade hybrid cloud infrastructure that securely connects my on-premises homelab environment with AWS. The implementation demonstrates enterprise-level network segmentation, DNS integration, and security practices using Infrastructure as Code (IaC) principles.\nArchitecture Goals My primary objectives were to:\nEstablish secure connectivity between on-premises and AWS environments Implement seamless DNS resolution across both environments Maintain security isolation while enabling necessary communication Use Infrastructure as Code for reproducible deployments Follow enterprise best practices for hybrid cloud architectures On-Premises Infrastructure Overview My existing homelab infrastructure includes:\n",
  "keywords": [
    "AWS", "On-Premise", "Hybrid", "Cloud", "Route", "DNS", "Samba4", "EC2", "Bastion", "VPC", "VPN", "IPsec", "terraform", "PfSense", "infrastructure-as-code", "network", "automation", "cloud", "deployment"
  ],
  "articleBody": "Overview This post documents my journey building a production-grade hybrid cloud infrastructure that securely connects my on-premises homelab environment with AWS. The implementation demonstrates enterprise-level network segmentation, DNS integration, and security practices using Infrastructure as Code (IaC) principles.\nArchitecture Goals My primary objectives were to:\nEstablish secure connectivity between on-premises and AWS environments Implement seamless DNS resolution across both environments Maintain security isolation while enabling necessary communication Use Infrastructure as Code for reproducible deployments Follow enterprise best practices for hybrid cloud architectures On-Premises Infrastructure Overview My existing homelab infrastructure includes:\nSamba4 Active Directory Domain Controller (172.30.30.30) - Authoritative DNS for tillynet.lan Pi-hole DNS Server (172.21.21.21) - Recursive DNS with ad-blocking pfSense Firewall/Router - Network segmentation and routing VLAN Segmentation: VLAN 1: Default/legacy (172.16.7.0/24) VLAN 14: Guest Wi-Fi (172.16.14.0/24) VLAN 21: Production (172.21.21.0/24) VLAN 99: Management (172.16.99.0/24) Infrastructure subnet: (172.30.30.0/24) DNS Hierarchy My DNS architecture follows enterprise patterns:\nClient Queries → Samba4 AD DC (Authoritative) → Pi-hole (Recursive) → External DNS This design provides centralized domain management while maintaining ad-blocking and filtering capabilities.\nAWS Infrastructure Design Network Architecture I designed the AWS VPC to avoid IP conflicts with my on-premises networks:\n# locals.tf locals { # AWS VPC CIDR - ensuring no overlap with home networks vpc_cidr = \"10.1.0.0/16\" # Subnet CIDRs public_subnet_cidr = \"10.1.1.0/24\" private_subnet_cidr = \"10.1.2.0/24\" # My home network CIDRs home_networks = [ \"172.16.7.0/24\", # Default/legacy VLAN 1 \"172.16.14.0/24\", # Guest Wi-Fi VLAN 14 \"172.21.21.0/24\", # Production VLAN 21 \"172.16.99.0/24\", # Management VLAN 99 \"172.30.30.0/24\" # Internal Infrastructure Subnet ] } VPC and Core Infrastructure # main.tf # VPC for hybrid connectivity resource \"aws_vpc\" \"hybrid_vpc\" { cidr_block = local.vpc_cidr enable_dns_hostnames = true enable_dns_support = true tags = merge(local.common_tags, { Name = \"${var.project_name}-hybrid-vpc\" }) } # Public Subnet (for NAT Gateway, bastion, etc.) resource \"aws_subnet\" \"public_subnet\" { vpc_id = aws_vpc.hybrid_vpc.id cidr_block = local.public_subnet_cidr availability_zone = data.aws_availability_zones.available.names[0] map_public_ip_on_launch = true tags = merge(local.common_tags, { Name = \"${var.project_name}-public-subnet\" Type = \"Public\" }) } # Private Subnet (for hybrid workloads) resource \"aws_subnet\" \"private_subnet\" { vpc_id = aws_vpc.hybrid_vpc.id cidr_block = local.private_subnet_cidr availability_zone = data.aws_availability_zones.available.names[0] tags = merge(local.common_tags, { Name = \"${var.project_name}-private-subnet\" Type = \"Private\" }) } This architecture provides:\nNetwork isolation between public and private resources NAT Gateway for outbound internet access from private subnet Route table separation for granular traffic control VPN Connectivity Implementation Customer Gateway and VPN Connection # Customer Gateway (represents my pfSense firewall) resource \"aws_customer_gateway\" \"tillynet_cgw\" { bgp_asn = 65000 # Standard private ASN ip_address = var.home_public_ip type = \"ipsec.1\" tags = merge(local.common_tags, { Name = \"${var.project_name}-tillynet-gateway\" }) } # Virtual Private Gateway resource \"aws_vpn_gateway\" \"hybrid_vgw\" { vpc_id = aws_vpc.hybrid_vpc.id tags = merge(local.common_tags, { Name = \"${var.project_name}-vpn-gateway\" }) } # VPN Connection resource \"aws_vpn_connection\" \"tillynet_vpn_enhanced\" { customer_gateway_id = aws_customer_gateway.tillynet_cgw.id vpn_gateway_id = aws_vpn_gateway.hybrid_vgw.id type = \"ipsec.1\" static_routes_only = true # Enhanced tunnel options with correct AWS values tunnel1_ike_versions = [\"ikev2\"] tunnel1_phase1_encryption_algorithms = [\"AES256\"] tunnel1_phase1_integrity_algorithms = [\"SHA2-256\"] tunnel1_phase1_dh_group_numbers = [14] tunnel1_phase2_encryption_algorithms = [\"AES256\"] tunnel1_phase2_integrity_algorithms = [\"SHA2-256\"] tunnel1_phase2_dh_group_numbers = [14] tunnel2_ike_versions = [\"ikev2\"] tunnel2_phase1_encryption_algorithms = [\"AES256\"] tunnel2_phase1_integrity_algorithms = [\"SHA2-256\"] tunnel2_phase1_dh_group_numbers = [14] tunnel2_phase2_encryption_algorithms = [\"AES256\"] tunnel2_phase2_integrity_algorithms = [\"SHA2-256\"] tunnel2_phase2_dh_group_numbers = [14] tags = merge(local.common_tags, { Name = \"${var.project_name}-vpn-connection-enhanced\" }) } VPN Route Configuration # VPN Connection Routes (for my home networks) resource \"aws_vpn_connection_route\" \"home_routes_enhanced\" { count = length(local.home_networks) vpn_connection_id = aws_vpn_connection.tillynet_vpn_enhanced.id destination_cidr_block = local.home_networks[count.index] } # Propagate VPN routes to private route table resource \"aws_vpn_gateway_route_propagation\" \"private_propagation_enhanced\" { vpn_gateway_id = aws_vpn_gateway.hybrid_vgw.id route_table_id = aws_route_table.private_rt.id depends_on = [aws_vpn_connection.tillynet_vpn_enhanced] } This configuration automatically advertises all my on-premises networks to AWS and enables route propagation for seamless connectivity.\nDNS Infrastructure Design Route 53 Resolver Endpoints To enable bi-directional DNS resolution, I implemented Route 53 Resolver endpoints:\n# dns.tf # Route 53 Resolver Inbound Endpoint (for on-prem to AWS queries) resource \"aws_route53_resolver_endpoint\" \"inbound\" { name = \"${var.project_name}-inbound-resolver\" direction = \"INBOUND\" security_group_ids = [aws_security_group.dns_resolver_sg.id] ip_address { subnet_id = aws_subnet.private_subnet.id ip = \"10.1.2.10\" } ip_address { subnet_id = aws_subnet.public_subnet.id ip = \"10.1.1.10\" } tags = merge(local.common_tags, { Name = \"${var.project_name}-inbound-resolver\" }) } # Route 53 Resolver Outbound Endpoint (for AWS to on-prem queries) resource \"aws_route53_resolver_endpoint\" \"outbound\" { name = \"${var.project_name}-outbound-resolver\" direction = \"OUTBOUND\" security_group_ids = [aws_security_group.dns_resolver_sg.id] ip_address { subnet_id = aws_subnet.private_subnet.id ip = \"10.1.2.11\" } ip_address { subnet_id = aws_subnet.public_subnet.id ip = \"10.1.1.11\" } tags = merge(local.common_tags, { Name = \"${var.project_name}-outbound-resolver\" }) } Forward Resolution Rules # Forwarding rule to send tillynet.lan queries to my Samba4 DC resource \"aws_route53_resolver_rule\" \"onprem_forward\" { domain_name = \"tillynet.lan\" name = \"${var.project_name}-onprem-forward\" rule_type = \"FORWARD\" resolver_endpoint_id = aws_route53_resolver_endpoint.outbound.id target_ip { ip = \"172.30.30.30\" # my Samba4 DC IP port = 53 } tags = merge(local.common_tags, { Name = \"${var.project_name}-onprem-forward\" }) } This enables AWS instances to resolve my on-premises domain names.\nPrivate Hosted Zone # Private hosted zone for aws.tillynet.lan resource \"aws_route53_zone\" \"aws_private\" { name = \"aws.tillynet.lan\" vpc { vpc_id = aws_vpc.hybrid_vpc.id } tags = merge(local.common_tags, { Name = \"${var.project_name}-aws-private-zone\" }) } Security Implementation Security Groups I implemented least-privilege security groups for each component:\n# DNS Resolver Security Group resource \"aws_security_group\" \"dns_resolver_sg\" { name_prefix = \"${var.project_name}-dns-resolver-\" description = \"Security group for Route 53 Resolver endpoints\" vpc_id = aws_vpc.hybrid_vpc.id ingress { description = \"DNS from on-premises networks\" from_port = 53 to_port = 53 protocol = \"udp\" cidr_blocks = local.home_networks } ingress { description = \"DNS TCP from on-premises networks\" from_port = 53 to_port = 53 protocol = \"tcp\" cidr_blocks = local.home_networks } egress { description = \"DNS to on-premises\" from_port = 53 to_port = 53 protocol = \"udp\" cidr_blocks = local.home_networks } tags = merge(local.common_tags, { Name = \"${var.project_name}-dns-resolver-sg\" }) } # Private Instance Security Group resource \"aws_security_group\" \"private_sg\" { name_prefix = \"${var.project_name}-private-\" description = \"Security group for private instances\" vpc_id = aws_vpc.hybrid_vpc.id ingress { description = \"SSH from home networks\" from_port = 22 to_port = 22 protocol = \"tcp\" cidr_blocks = local.home_networks } ingress { description = \"HTTPS from home networks\" from_port = 443 to_port = 443 protocol = \"tcp\" cidr_blocks = local.home_networks } egress { description = \"All outbound\" from_port = 0 to_port = 0 protocol = \"-1\" cidr_blocks = [\"0.0.0.0/0\"] } tags = merge(local.common_tags, { Name = \"${var.project_name}-private-sg\" }) } Bastion Host Security The bastion host implements a critical security pattern:\n# Bastion Host Security Group resource \"aws_security_group\" \"bastion_sg\" { name_prefix = \"${var.project_name}-bastion-\" description = \"Security group for bastion host\" vpc_id = aws_vpc.hybrid_vpc.id ingress { description = \"SSH from internet (backup access)\" from_port = 22 to_port = 22 protocol = \"tcp\" cidr_blocks = [\"${var.home_public_ip}/32\"] } # Note: SSH from on-premises networks is intentionally blocked # This forces proper access patterns for security egress { description = \"All outbound\" from_port = 0 to_port = 0 protocol = \"-1\" cidr_blocks = [\"0.0.0.0/0\"] } tags = merge(local.common_tags, { Name = \"${var.project_name}-bastion-sg\" }) } This design enforces different access patterns:\nBastion host: Internet → AWS entry point only Private instances: On-premises ↔ AWS communication No lateral movement from on-premises to bastion EC2 Instance Deployment IAM Roles and Instance Profiles # IAM role for EC2 instances resource \"aws_iam_role\" \"ec2_hybrid_role\" { name = \"${var.project_name}-ec2-hybrid-role\" assume_role_policy = jsonencode({ Version = \"2012-10-17\" Statement = [ { Action = \"sts:AssumeRole\" Effect = \"Allow\" Principal = { Service = \"ec2.amazonaws.com\" } } ] }) tags = local.common_tags } # IAM policy for EC2 instances resource \"aws_iam_role_policy\" \"ec2_hybrid_policy\" { name = \"${var.project_name}-ec2-hybrid-policy\" role = aws_iam_role.ec2_hybrid_role.id policy = jsonencode({ Version = \"2012-10-17\" Statement = [ { Effect = \"Allow\" Action = [ \"route53:ListHostedZones\", \"route53:GetHostedZone\", \"route53:ChangeResourceRecordSets\", \"route53:GetChange\" ] Resource = \"*\" } ] }) } Instance Configuration # Private Instance for hybrid workloads resource \"aws_instance\" \"hybrid_app\" { ami = data.aws_ami.amazon_linux.id instance_type = \"t3.micro\" key_name = var.key_pair_name subnet_id = aws_subnet.private_subnet.id vpc_security_group_ids = [aws_security_group.private_sg.id] iam_instance_profile = aws_iam_instance_profile.ec2_hybrid_profile.name user_data = base64encode(templatefile(\"${path.module}/user-data/app-userdata.sh\", { hostname = \"app01\" project = var.project_name environment = \"hybrid\" samba_dc_ip = \"172.30.30.30\" dns_resolver_ip = \"10.1.2.10\" })) tags = merge(local.common_tags, { Name = \"${var.project_name}-app01\" Role = \"Application\" }) } DNS Integration Challenges and Solutions Initial Approach: DNS Delegation My first approach attempted to use DNS delegation from Samba4 to AWS Route 53:\n# Create AWS subdomain zone sudo samba-tool dns zonecreate 172.30.30.30 aws.tillynet.lan -U Administrator # Add NS record for delegation sudo samba-tool dns add 172.30.30.30 tillynet.lan aws NS aws-resolver.tillynet.lan -U Administrator # Add glue record sudo samba-tool dns add 172.30.30.30 tillynet.lan aws-resolver A 10.1.2.10 -U Administrator Problems Encountered Resolver Connectivity Issues\n# Testing both resolver IPs nslookup app01.aws.tillynet.lan 10.1.1.10 # Timeout nslookup app01.aws.tillynet.lan 10.1.2.10 # Success By design only the private subnet resolver (10.1.2.10) was reachable from my on-prem networks since traffic between my on-prem networks and aws-public-subnets was not permitted.\nSamba4 Delegation Behavior\nSamba4 doesn’t follow NS delegation for subdomains like traditional DNS servers. Even with correct delegation setup, queries weren’t being forwarded properly.\nConflicting NS Records\nHaving both samba.tillynet.lan and aws-resolver.tillynet.lan as nameservers created resolution conflicts.\nFinal Solution: Direct Zone Management I resolved the issues by making Samba4 directly authoritative for the AWS subdomain:\n# Remove delegation records sudo samba-tool dns delete 172.30.30.30 tillynet.lan aws NS aws-resolver.tillynet.lan -U Administrator sudo samba-tool dns delete 172.30.30.30 tillynet.lan aws-resolver A 10.1.2.10 -U Administrator # Add records directly to the aws zone sudo samba-tool dns add 172.30.30.30 aws.tillynet.lan app01 A 10.1.2.76 -U Administrator sudo samba-tool dns add 172.30.30.30 aws.tillynet.lan bastion A 10.1.1.101 -U Administrator This approach provides:\nImmediate resolution without delegation complexity Central management of all DNS records Better performance (no network hops to AWS) Simplified troubleshooting Connectivity Testing and Validation VPN Tunnel Verification # Test connectivity using allowed ports (SSH) ssh 10.1.2.76 # Success - shows VPN is working DNS Resolution Testing # Test from on-premises nslookup app01.aws.tillynet.lan 172.30.30.30 # Returns: 10.1.2.76 # Test SSH using DNS names ssh -i keypair.pem ec2-user@app01.aws.tillynet.lan # Success! Cross-Environment Access Patterns From On-Premises to AWS:\nPrivate instances: Direct SSH via VPN tunnel Bastion host: SSH from internet only (security best practice) From AWS to On-Premises:\nAll on-premises services accessible via VPN DNS resolution works bi-directionally Security Best Practices Implemented Network Segmentation VPC isolation with no overlapping IP ranges Security groups implementing least-privilege access Subnet separation between public and private resources Access Control Bastion host restricted to internet access only Private instances accessible from on-premises networks IAM roles instead of embedded credentials Monitoring and Logging VPC Flow Logs for traffic analysis CloudTrail for API auditing Security group logging for access attempts Automation and Infrastructure as Code The entire infrastructure is managed through Terraform, providing:\nVariable Configuration # terraform.tfvars aws_region = \"us-west-1\" home_public_ip = \"XXX.XXX.XXX.XXX\" project_name = \"tillynet-hybrid\" key_pair_name = \"tillynet-aws-keypair-general\" Modular Design Separate files for different components (dns.tf, security-groups.tf, instances.tf) Reusable variables and locals Consistent tagging strategy Deployment Validation terraform validate terraform plan terraform apply Lessons Learned DNS Delegation Complexity Challenge: Samba4 doesn’t handle DNS delegation like traditional DNS servers. Solution: Direct zone management is often simpler and more reliable for hybrid environments.\nSecurity Group Design Challenge: Balancing security with functionality. Solution: Implement different access patterns for different resource types (bastion vs. private instances).\nRoute 53 Resolver Placement Challenge: Not all resolver endpoints may be reachable. Solution: Test connectivity to all endpoints and use only working ones.\nPerformance and Cost Considerations Network Performance VPN tunnel latency: ~75-85ms (acceptable for hybrid operations) DNS resolution: Sub-second response times Throughput: Sufficient for management and application traffic Cost Optimization t3.micro instances: Free tier eligible NAT Gateway: ~$32/month (necessary for private subnet internet access) VPN Connection: ~$36/month (fixed cost) Route 53 Resolver: ~$0.125/hour per endpoint Future Enhancements Planned Improvements Certificate Management: Extend on-premises PKI to AWS services Service Mesh: Implement secure service-to-service communication Monitoring Integration: Centralized logging and monitoring Automation: Ansible playbooks for configuration management Scalability Considerations Multi-AZ deployment for high availability Auto Scaling Groups for dynamic capacity Load balancers for service distribution Container orchestration for microservices Conclusion This hybrid infrastructure implementation demonstrates enterprise-grade practices for securely connecting on-premises and cloud environments. The combination of proper network segmentation, security controls, and DNS integration provides a solid foundation for hybrid cloud operations.\nKey achievements:\nSecure VPN connectivity between environments Seamless DNS resolution across hybrid infrastructure Defense-in-depth security with multiple isolation layers Infrastructure as Code for reproducible deployments Scalable architecture ready for service expansion The pragmatic approach of using direct DNS zone management over complex delegation proved that sometimes the simplest solution that works is better than a theoretically perfect solution that doesn’t. This infrastructure now serves as the foundation for deploying hybrid applications and services across both environments.\nTechnical Specifications Infrastructure Components:\nAWS VPC with public/private subnets Site-to-site VPN with static routing Route 53 Resolver endpoints for DNS EC2 instances with IAM roles Security groups with least-privilege access Network Architecture:\nOn-premises: Multiple VLANs (172.16.x.x/24, 172.21.21.0/24, 172.30.30.0/24) AWS: 10.1.0.0/16 with /24 subnets VPN: IPsec with AES256 encryption DNS Architecture:\nSamba4 AD DC: Authoritative for tillynet.lan and aws.tillynet.lan Pi-hole: Recursive resolver with ad-blocking Route 53: AWS service resolution and forwarding ",
  "wordCount" : "2090",
  "inLanguage": "en",
  "datePublished": "2025-06-04T00:00:00Z",
  "dateModified": "2025-06-04T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.tillynet.com/cloud-engineering-labs/aws-lab-4/building-a-secure-hybrid-cloud-infrastructure-with-aws-vpn-and-dns-integration/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Tilly Net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.tillynet.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.tillynet.com/" accesskey="h" title="Tilly Net (Alt + H)">Tilly Net</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.tillynet.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/on-premise-engineering-labs/" title="On-Premise Engineering Labs">
                    <span>On-Premise Engineering Labs</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/cloud-engineering-labs" title="Cloud Engineering Labs">
                    <span>Cloud Engineering Labs</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://blog.tillynet.com/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Building a Secure Hybrid Cloud Infrastructure with AWS VPN and DNS Integration
    </h1>
    <div class="post-meta"><span title='2025-06-04 00:00:00 +0000 UTC'>June 4, 2025</span>&nbsp;·&nbsp;10 min

</div>
  </header> 
  <div class="post-content"><h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<p>This post documents my journey building a production-grade hybrid cloud infrastructure that securely connects my on-premises homelab environment with AWS. The implementation demonstrates enterprise-level network segmentation, DNS integration, and security practices using Infrastructure as Code (IaC) principles.</p>
<h2 id="architecture-goals">Architecture Goals<a hidden class="anchor" aria-hidden="true" href="#architecture-goals">#</a></h2>
<p>My primary objectives were to:</p>
<ul>
<li><strong>Establish secure connectivity</strong> between on-premises and AWS environments</li>
<li><strong>Implement seamless DNS resolution</strong> across both environments</li>
<li><strong>Maintain security isolation</strong> while enabling necessary communication</li>
<li><strong>Use Infrastructure as Code</strong> for reproducible deployments</li>
<li><strong>Follow enterprise best practices</strong> for hybrid cloud architectures</li>
</ul>
<h2 id="on-premises-infrastructure-overview">On-Premises Infrastructure Overview<a hidden class="anchor" aria-hidden="true" href="#on-premises-infrastructure-overview">#</a></h2>
<p>My existing homelab infrastructure includes:</p>
<ul>
<li><strong>Samba4 Active Directory Domain Controller</strong> (172.30.30.30) - Authoritative DNS for <code>tillynet.lan</code></li>
<li><strong>Pi-hole DNS Server</strong> (172.21.21.21) - Recursive DNS with ad-blocking</li>
<li><strong>pfSense Firewall/Router</strong> - Network segmentation and routing</li>
<li><strong>VLAN Segmentation</strong>:
<ul>
<li>VLAN 1: Default/legacy (172.16.7.0/24)</li>
<li>VLAN 14: Guest Wi-Fi (172.16.14.0/24)</li>
<li>VLAN 21: Production (172.21.21.0/24)</li>
<li>VLAN 99: Management (172.16.99.0/24)</li>
<li>Infrastructure subnet: (172.30.30.0/24)</li>
</ul>
</li>
</ul>
<h3 id="dns-hierarchy">DNS Hierarchy<a hidden class="anchor" aria-hidden="true" href="#dns-hierarchy">#</a></h3>
<p>My DNS architecture follows enterprise patterns:</p>
<pre tabindex="0"><code>Client Queries → Samba4 AD DC (Authoritative) → Pi-hole (Recursive) → External DNS
</code></pre><p>This design provides centralized domain management while maintaining ad-blocking and filtering capabilities.</p>
<h2 id="aws-infrastructure-design">AWS Infrastructure Design<a hidden class="anchor" aria-hidden="true" href="#aws-infrastructure-design">#</a></h2>
<h3 id="network-architecture">Network Architecture<a hidden class="anchor" aria-hidden="true" href="#network-architecture">#</a></h3>
<p>I designed the AWS VPC to avoid IP conflicts with my on-premises networks:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># locals.tf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">locals</span> {<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # AWS VPC CIDR - ensuring no overlap with home networks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  vpc_cidr</span> <span class="o">=</span> <span class="s2">&#34;10.1.0.0/16&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # Subnet CIDRs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  public_subnet_cidr</span>  <span class="o">=</span> <span class="s2">&#34;10.1.1.0/24&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnet_cidr</span> <span class="o">=</span> <span class="s2">&#34;10.1.2.0/24&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # My home network CIDRs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  home_networks</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;172.16.7.0/24&#34;</span><span class="p">,</span><span class="c1">  # Default/legacy VLAN 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s2">&#34;172.16.14.0/24&#34;</span><span class="p">,</span><span class="c1"> # Guest Wi-Fi VLAN 14
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s2">&#34;172.21.21.0/24&#34;</span><span class="p">,</span><span class="c1"> # Production VLAN 21
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s2">&#34;172.16.99.0/24&#34;</span><span class="p">,</span><span class="c1"> # Management VLAN 99
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s2">&#34;172.30.30.0/24&#34;</span><span class="c1">  # Internal Infrastructure Subnet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h3 id="vpc-and-core-infrastructure">VPC and Core Infrastructure<a hidden class="anchor" aria-hidden="true" href="#vpc-and-core-infrastructure">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># main.tf
</span></span></span><span class="line"><span class="cl"><span class="c1"># VPC for hybrid connectivity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpc&#34; &#34;hybrid_vpc&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>           <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">vpc_cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  enable_dns_hostnames</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  enable_dns_support</span>   <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-hybrid-vpc&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Public Subnet (for NAT Gateway, bastion, etc.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;public_subnet&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>                  <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">hybrid_vpc</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>              <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">public_subnet_cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span>       <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_availability_zones</span><span class="p">.</span><span class="k">available</span><span class="p">.</span><span class="k">names</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  map_public_ip_on_launch</span> <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-public-subnet&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    Type</span> <span class="o">=</span> <span class="s2">&#34;Public&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Private Subnet (for hybrid workloads)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;private_subnet&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>            <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">hybrid_vpc</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">private_subnet_cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span> <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_availability_zones</span><span class="p">.</span><span class="k">available</span><span class="p">.</span><span class="k">names</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-private-subnet&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    Type</span> <span class="o">=</span> <span class="s2">&#34;Private&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>This architecture provides:</p>
<ul>
<li><strong>Network isolation</strong> between public and private resources</li>
<li><strong>NAT Gateway</strong> for outbound internet access from private subnet</li>
<li><strong>Route table separation</strong> for granular traffic control</li>
</ul>
<h2 id="vpn-connectivity-implementation">VPN Connectivity Implementation<a hidden class="anchor" aria-hidden="true" href="#vpn-connectivity-implementation">#</a></h2>
<h3 id="customer-gateway-and-vpn-connection">Customer Gateway and VPN Connection<a hidden class="anchor" aria-hidden="true" href="#customer-gateway-and-vpn-connection">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># Customer Gateway (represents my pfSense firewall)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_customer_gateway&#34; &#34;tillynet_cgw&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  bgp_asn</span>    <span class="o">=</span> <span class="m">65000</span><span class="c1"> # Standard private ASN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  ip_address</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">home_public_ip</span>
</span></span><span class="line"><span class="cl"><span class="n">  type</span>       <span class="o">=</span> <span class="s2">&#34;ipsec.1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-tillynet-gateway&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Virtual Private Gateway
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpn_gateway&#34; &#34;hybrid_vgw&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">hybrid_vpc</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-vpn-gateway&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># VPN Connection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpn_connection&#34; &#34;tillynet_vpn_enhanced&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  customer_gateway_id</span> <span class="o">=</span> <span class="k">aws_customer_gateway</span><span class="p">.</span><span class="k">tillynet_cgw</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpn_gateway_id</span>      <span class="o">=</span> <span class="k">aws_vpn_gateway</span><span class="p">.</span><span class="k">hybrid_vgw</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  type</span>                <span class="o">=</span> <span class="s2">&#34;ipsec.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  static_routes_only</span>  <span class="o">=</span> <span class="kt">true</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # Enhanced tunnel options with correct AWS values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tunnel1_ike_versions</span>                 <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ikev2&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel1_phase1_encryption_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;AES256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel1_phase1_integrity_algorithms</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;SHA2-256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel1_phase1_dh_group_numbers</span>      <span class="o">=</span> <span class="p">[</span><span class="m">14</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel1_phase2_encryption_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;AES256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel1_phase2_integrity_algorithms</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;SHA2-256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel1_phase2_dh_group_numbers</span>      <span class="o">=</span> <span class="p">[</span><span class="m">14</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tunnel2_ike_versions</span>                 <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ikev2&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel2_phase1_encryption_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;AES256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel2_phase1_integrity_algorithms</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;SHA2-256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel2_phase1_dh_group_numbers</span>      <span class="o">=</span> <span class="p">[</span><span class="m">14</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel2_phase2_encryption_algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;AES256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel2_phase2_integrity_algorithms</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;SHA2-256&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tunnel2_phase2_dh_group_numbers</span>      <span class="o">=</span> <span class="p">[</span><span class="m">14</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-vpn-connection-enhanced&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h3 id="vpn-route-configuration">VPN Route Configuration<a hidden class="anchor" aria-hidden="true" href="#vpn-route-configuration">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># VPN Connection Routes (for my home networks)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpn_connection_route&#34; &#34;home_routes_enhanced&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span>                  <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">home_networks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpn_connection_id</span>      <span class="o">=</span> <span class="k">aws_vpn_connection</span><span class="p">.</span><span class="k">tillynet_vpn_enhanced</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">home_networks</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Propagate VPN routes to private route table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpn_gateway_route_propagation&#34; &#34;private_propagation_enhanced&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpn_gateway_id</span> <span class="o">=</span> <span class="k">aws_vpn_gateway</span><span class="p">.</span><span class="k">hybrid_vgw</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private_rt</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  depends_on</span>     <span class="o">=</span> <span class="p">[</span><span class="k">aws_vpn_connection</span><span class="p">.</span><span class="k">tillynet_vpn_enhanced</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>This configuration automatically advertises all my on-premises networks to AWS and enables route propagation for seamless connectivity.</p>
<h2 id="dns-infrastructure-design">DNS Infrastructure Design<a hidden class="anchor" aria-hidden="true" href="#dns-infrastructure-design">#</a></h2>
<h3 id="route-53-resolver-endpoints">Route 53 Resolver Endpoints<a hidden class="anchor" aria-hidden="true" href="#route-53-resolver-endpoints">#</a></h3>
<p>To enable bi-directional DNS resolution, I implemented Route 53 Resolver endpoints:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># dns.tf
</span></span></span><span class="line"><span class="cl"><span class="c1"># Route 53 Resolver Inbound Endpoint (for on-prem to AWS queries)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route53_resolver_endpoint&#34; &#34;inbound&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>      <span class="o">=</span> <span class="s2">&#34;${var.project_name}-inbound-resolver&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  direction</span> <span class="o">=</span> <span class="s2">&#34;INBOUND&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="k">aws_security_group</span><span class="p">.</span><span class="k">dns_resolver_sg</span><span class="p">.</span><span class="k">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ip_address</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_id</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private_subnet</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">    ip</span>        <span class="o">=</span> <span class="s2">&#34;10.1.2.10&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ip_address</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_id</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public_subnet</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">    ip</span>        <span class="o">=</span> <span class="s2">&#34;10.1.1.10&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-inbound-resolver&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Route 53 Resolver Outbound Endpoint (for AWS to on-prem queries)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route53_resolver_endpoint&#34; &#34;outbound&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>      <span class="o">=</span> <span class="s2">&#34;${var.project_name}-outbound-resolver&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  direction</span> <span class="o">=</span> <span class="s2">&#34;OUTBOUND&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="k">aws_security_group</span><span class="p">.</span><span class="k">dns_resolver_sg</span><span class="p">.</span><span class="k">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ip_address</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_id</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private_subnet</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">    ip</span>        <span class="o">=</span> <span class="s2">&#34;10.1.2.11&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ip_address</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_id</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public_subnet</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">    ip</span>        <span class="o">=</span> <span class="s2">&#34;10.1.1.11&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-outbound-resolver&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h3 id="forward-resolution-rules">Forward Resolution Rules<a hidden class="anchor" aria-hidden="true" href="#forward-resolution-rules">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># Forwarding rule to send tillynet.lan queries to my Samba4 DC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route53_resolver_rule&#34; &#34;onprem_forward&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  domain_name</span>          <span class="o">=</span> <span class="s2">&#34;tillynet.lan&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  name</span>                 <span class="o">=</span> <span class="s2">&#34;${var.project_name}-onprem-forward&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  rule_type</span>            <span class="o">=</span> <span class="s2">&#34;FORWARD&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  resolver_endpoint_id</span> <span class="o">=</span> <span class="k">aws_route53_resolver_endpoint</span><span class="p">.</span><span class="k">outbound</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">target_ip</span> {
</span></span><span class="line"><span class="cl"><span class="n">    ip</span>   <span class="o">=</span> <span class="s2">&#34;172.30.30.30&#34;</span><span class="c1"> # my Samba4 DC IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    port</span> <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-onprem-forward&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>This enables AWS instances to resolve my on-premises domain names.</p>
<h3 id="private-hosted-zone">Private Hosted Zone<a hidden class="anchor" aria-hidden="true" href="#private-hosted-zone">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># Private hosted zone for aws.tillynet.lan
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route53_zone&#34; &#34;aws_private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;aws.tillynet.lan&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">vpc</span> {
</span></span><span class="line"><span class="cl"><span class="n">    vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">hybrid_vpc</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-aws-private-zone&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="security-implementation">Security Implementation<a hidden class="anchor" aria-hidden="true" href="#security-implementation">#</a></h2>
<h3 id="security-groups">Security Groups<a hidden class="anchor" aria-hidden="true" href="#security-groups">#</a></h3>
<p>I implemented least-privilege security groups for each component:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># DNS Resolver Security Group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_security_group&#34; &#34;dns_resolver_sg&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name_prefix</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-dns-resolver-&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;Security group for Route 53 Resolver endpoints&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>      <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">hybrid_vpc</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ingress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;DNS from on-premises networks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;udp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">home_networks</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ingress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;DNS TCP from on-premises networks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">home_networks</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">egress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;DNS to on-premises&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;udp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">home_networks</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-dns-resolver-sg&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Private Instance Security Group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_security_group&#34; &#34;private_sg&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name_prefix</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-private-&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;Security group for private instances&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>      <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">hybrid_vpc</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ingress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;SSH from home networks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">home_networks</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ingress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;HTTPS from home networks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">443</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">443</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">home_networks</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">egress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;All outbound&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;-1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0.0.0.0/0&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-private-sg&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h3 id="bastion-host-security">Bastion Host Security<a hidden class="anchor" aria-hidden="true" href="#bastion-host-security">#</a></h3>
<p>The bastion host implements a critical security pattern:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># Bastion Host Security Group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_security_group&#34; &#34;bastion_sg&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name_prefix</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-bastion-&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;Security group for bastion host&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>      <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">hybrid_vpc</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">ingress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;SSH from internet (backup access)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;${var.home_public_ip}/32&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # Note: SSH from on-premises networks is intentionally blocked
</span></span></span><span class="line"><span class="cl"><span class="c1">  # This forces proper access patterns for security
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">egress</span> {
</span></span><span class="line"><span class="cl"><span class="n">    description</span> <span class="o">=</span> <span class="s2">&#34;All outbound&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    from_port</span>   <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">    to_port</span>     <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">    protocol</span>    <span class="o">=</span> <span class="s2">&#34;-1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0.0.0.0/0&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-bastion-sg&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>This design enforces different access patterns:</p>
<ul>
<li><strong>Bastion host</strong>: Internet → AWS entry point only</li>
<li><strong>Private instances</strong>: On-premises ↔ AWS communication</li>
<li><strong>No lateral movement</strong> from on-premises to bastion</li>
</ul>
<h2 id="ec2-instance-deployment">EC2 Instance Deployment<a hidden class="anchor" aria-hidden="true" href="#ec2-instance-deployment">#</a></h2>
<h3 id="iam-roles-and-instance-profiles">IAM Roles and Instance Profiles<a hidden class="anchor" aria-hidden="true" href="#iam-roles-and-instance-profiles">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># IAM role for EC2 instances
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;ec2_hybrid_role&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-ec2-hybrid-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      {
</span></span><span class="line"><span class="cl"><span class="n">        Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">        Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">        Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">          Service</span> <span class="o">=</span> <span class="s2">&#34;ec2.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">common_tags</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># IAM policy for EC2 instances
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy&#34; &#34;ec2_hybrid_policy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-ec2-hybrid-policy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">ec2_hybrid_role</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      {
</span></span><span class="line"><span class="cl"><span class="n">        Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">        Action</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;route53:ListHostedZones&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;route53:GetHostedZone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;route53:ChangeResourceRecordSets&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;route53:GetChange&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">        Resource</span> <span class="o">=</span> <span class="s2">&#34;*&#34;</span>
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h3 id="instance-configuration">Instance Configuration<a hidden class="anchor" aria-hidden="true" href="#instance-configuration">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># Private Instance for hybrid workloads
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_instance&#34; &#34;hybrid_app&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  ami</span>                    <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">aws_ami</span><span class="p">.</span><span class="k">amazon_linux</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  instance_type</span>          <span class="o">=</span> <span class="s2">&#34;t3.micro&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  key_name</span>               <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">key_pair_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>              <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private_subnet</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="k">aws_security_group</span><span class="p">.</span><span class="k">private_sg</span><span class="p">.</span><span class="k">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  iam_instance_profile</span>   <span class="o">=</span> <span class="k">aws_iam_instance_profile</span><span class="p">.</span><span class="k">ec2_hybrid_profile</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  user_data</span> <span class="o">=</span> <span class="k">base64encode</span><span class="p">(</span><span class="k">templatefile</span><span class="p">(</span><span class="s2">&#34;${path.module}/user-data/app-userdata.sh&#34;</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    hostname</span>        <span class="o">=</span> <span class="s2">&#34;app01&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    project</span>         <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">project_name</span>
</span></span><span class="line"><span class="cl"><span class="n">    environment</span>     <span class="o">=</span> <span class="s2">&#34;hybrid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    samba_dc_ip</span>     <span class="o">=</span> <span class="s2">&#34;172.30.30.30&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    dns_resolver_ip</span> <span class="o">=</span> <span class="s2">&#34;10.1.2.10&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> <span class="k">merge</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">common_tags</span><span class="p">,</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${var.project_name}-app01&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">    Role</span> <span class="o">=</span> <span class="s2">&#34;Application&#34;</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="dns-integration-challenges-and-solutions">DNS Integration Challenges and Solutions<a hidden class="anchor" aria-hidden="true" href="#dns-integration-challenges-and-solutions">#</a></h2>
<h3 id="initial-approach-dns-delegation">Initial Approach: DNS Delegation<a hidden class="anchor" aria-hidden="true" href="#initial-approach-dns-delegation">#</a></h3>
<p>My first approach attempted to use DNS delegation from Samba4 to AWS Route 53:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Create AWS subdomain zone</span>
</span></span><span class="line"><span class="cl">sudo samba-tool dns zonecreate 172.30.30.30 aws.tillynet.lan -U Administrator
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add NS record for delegation</span>
</span></span><span class="line"><span class="cl">sudo samba-tool dns add 172.30.30.30 tillynet.lan aws NS aws-resolver.tillynet.lan -U Administrator
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add glue record</span>
</span></span><span class="line"><span class="cl">sudo samba-tool dns add 172.30.30.30 tillynet.lan aws-resolver A 10.1.2.10 -U Administrator
</span></span></code></pre></div><h3 id="problems-encountered">Problems Encountered<a hidden class="anchor" aria-hidden="true" href="#problems-encountered">#</a></h3>
<ol>
<li>
<p><strong>Resolver Connectivity Issues</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Testing both resolver IPs</span>
</span></span><span class="line"><span class="cl">nslookup app01.aws.tillynet.lan 10.1.1.10  <span class="c1"># Timeout</span>
</span></span><span class="line"><span class="cl">nslookup app01.aws.tillynet.lan 10.1.2.10  <span class="c1"># Success</span>
</span></span></code></pre></div><p>By design only the private subnet resolver (10.1.2.10) was reachable from my on-prem networks since traffic between my on-prem networks and aws-public-subnets was not permitted.</p>
</li>
<li>
<p><strong>Samba4 Delegation Behavior</strong></p>
<p>Samba4 doesn&rsquo;t follow NS delegation for subdomains like traditional DNS servers. Even with correct delegation setup, queries weren&rsquo;t being forwarded properly.</p>
</li>
<li>
<p><strong>Conflicting NS Records</strong></p>
<p>Having both <code>samba.tillynet.lan</code> and <code>aws-resolver.tillynet.lan</code> as nameservers created resolution conflicts.</p>
</li>
</ol>
<h3 id="final-solution-direct-zone-management">Final Solution: Direct Zone Management<a hidden class="anchor" aria-hidden="true" href="#final-solution-direct-zone-management">#</a></h3>
<p>I resolved the issues by making Samba4 directly authoritative for the AWS subdomain:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Remove delegation records</span>
</span></span><span class="line"><span class="cl">sudo samba-tool dns delete 172.30.30.30 tillynet.lan aws NS aws-resolver.tillynet.lan -U Administrator
</span></span><span class="line"><span class="cl">sudo samba-tool dns delete 172.30.30.30 tillynet.lan aws-resolver A 10.1.2.10 -U Administrator
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add records directly to the aws zone</span>
</span></span><span class="line"><span class="cl">sudo samba-tool dns add 172.30.30.30 aws.tillynet.lan app01 A 10.1.2.76 -U Administrator
</span></span><span class="line"><span class="cl">sudo samba-tool dns add 172.30.30.30 aws.tillynet.lan bastion A 10.1.1.101 -U Administrator
</span></span></code></pre></div><p>This approach provides:</p>
<ul>
<li><strong>Immediate resolution</strong> without delegation complexity</li>
<li><strong>Central management</strong> of all DNS records</li>
<li><strong>Better performance</strong> (no network hops to AWS)</li>
<li><strong>Simplified troubleshooting</strong></li>
</ul>
<h2 id="connectivity-testing-and-validation">Connectivity Testing and Validation<a hidden class="anchor" aria-hidden="true" href="#connectivity-testing-and-validation">#</a></h2>
<h3 id="vpn-tunnel-verification">VPN Tunnel Verification<a hidden class="anchor" aria-hidden="true" href="#vpn-tunnel-verification">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Test connectivity using allowed ports (SSH)</span>
</span></span><span class="line"><span class="cl">ssh 10.1.2.76  <span class="c1"># Success - shows VPN is working</span>
</span></span></code></pre></div><h3 id="dns-resolution-testing">DNS Resolution Testing<a hidden class="anchor" aria-hidden="true" href="#dns-resolution-testing">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Test from on-premises</span>
</span></span><span class="line"><span class="cl">nslookup app01.aws.tillynet.lan 172.30.30.30
</span></span><span class="line"><span class="cl"><span class="c1"># Returns: 10.1.2.76</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Test SSH using DNS names</span>
</span></span><span class="line"><span class="cl">ssh -i keypair.pem ec2-user@app01.aws.tillynet.lan
</span></span><span class="line"><span class="cl"><span class="c1"># Success!</span>
</span></span></code></pre></div><h3 id="cross-environment-access-patterns">Cross-Environment Access Patterns<a hidden class="anchor" aria-hidden="true" href="#cross-environment-access-patterns">#</a></h3>
<p><strong>From On-Premises to AWS:</strong></p>
<ul>
<li>Private instances: Direct SSH via VPN tunnel</li>
<li>Bastion host: SSH from internet only (security best practice)</li>
</ul>
<p><strong>From AWS to On-Premises:</strong></p>
<ul>
<li>All on-premises services accessible via VPN</li>
<li>DNS resolution works bi-directionally</li>
</ul>
<h2 id="security-best-practices-implemented">Security Best Practices Implemented<a hidden class="anchor" aria-hidden="true" href="#security-best-practices-implemented">#</a></h2>
<h3 id="network-segmentation">Network Segmentation<a hidden class="anchor" aria-hidden="true" href="#network-segmentation">#</a></h3>
<ul>
<li><strong>VPC isolation</strong> with no overlapping IP ranges</li>
<li><strong>Security groups</strong> implementing least-privilege access</li>
<li><strong>Subnet separation</strong> between public and private resources</li>
</ul>
<h3 id="access-control">Access Control<a hidden class="anchor" aria-hidden="true" href="#access-control">#</a></h3>
<ul>
<li><strong>Bastion host</strong> restricted to internet access only</li>
<li><strong>Private instances</strong> accessible from on-premises networks</li>
<li><strong>IAM roles</strong> instead of embedded credentials</li>
</ul>
<h3 id="monitoring-and-logging">Monitoring and Logging<a hidden class="anchor" aria-hidden="true" href="#monitoring-and-logging">#</a></h3>
<ul>
<li><strong>VPC Flow Logs</strong> for traffic analysis</li>
<li><strong>CloudTrail</strong> for API auditing</li>
<li><strong>Security group logging</strong> for access attempts</li>
</ul>
<h2 id="automation-and-infrastructure-as-code">Automation and Infrastructure as Code<a hidden class="anchor" aria-hidden="true" href="#automation-and-infrastructure-as-code">#</a></h2>
<p>The entire infrastructure is managed through Terraform, providing:</p>
<h3 id="variable-configuration">Variable Configuration<a hidden class="anchor" aria-hidden="true" href="#variable-configuration">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># terraform.tfvars
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">aws_region</span>     <span class="o">=</span> <span class="s2">&#34;us-west-1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">home_public_ip</span> <span class="o">=</span> <span class="s2">&#34;XXX.XXX.XXX.XXX&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">project_name</span>   <span class="o">=</span> <span class="s2">&#34;tillynet-hybrid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">key_pair_name</span>  <span class="o">=</span> <span class="s2">&#34;tillynet-aws-keypair-general&#34;</span>
</span></span></code></pre></div><h3 id="modular-design">Modular Design<a hidden class="anchor" aria-hidden="true" href="#modular-design">#</a></h3>
<ul>
<li>Separate files for different components (dns.tf, security-groups.tf, instances.tf)</li>
<li>Reusable variables and locals</li>
<li>Consistent tagging strategy</li>
</ul>
<h3 id="deployment-validation">Deployment Validation<a hidden class="anchor" aria-hidden="true" href="#deployment-validation">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">terraform validate
</span></span><span class="line"><span class="cl">terraform plan
</span></span><span class="line"><span class="cl">terraform apply
</span></span></code></pre></div><h2 id="lessons-learned">Lessons Learned<a hidden class="anchor" aria-hidden="true" href="#lessons-learned">#</a></h2>
<h3 id="dns-delegation-complexity">DNS Delegation Complexity<a hidden class="anchor" aria-hidden="true" href="#dns-delegation-complexity">#</a></h3>
<p><strong>Challenge</strong>: Samba4 doesn&rsquo;t handle DNS delegation like traditional DNS servers. <strong>Solution</strong>: Direct zone management is often simpler and more reliable for hybrid environments.</p>
<h3 id="security-group-design">Security Group Design<a hidden class="anchor" aria-hidden="true" href="#security-group-design">#</a></h3>
<p><strong>Challenge</strong>: Balancing security with functionality. <strong>Solution</strong>: Implement different access patterns for different resource types (bastion vs. private instances).</p>
<h3 id="route-53-resolver-placement">Route 53 Resolver Placement<a hidden class="anchor" aria-hidden="true" href="#route-53-resolver-placement">#</a></h3>
<p><strong>Challenge</strong>: Not all resolver endpoints may be reachable. <strong>Solution</strong>: Test connectivity to all endpoints and use only working ones.</p>
<h2 id="performance-and-cost-considerations">Performance and Cost Considerations<a hidden class="anchor" aria-hidden="true" href="#performance-and-cost-considerations">#</a></h2>
<h3 id="network-performance">Network Performance<a hidden class="anchor" aria-hidden="true" href="#network-performance">#</a></h3>
<ul>
<li><strong>VPN tunnel latency</strong>: ~75-85ms (acceptable for hybrid operations)</li>
<li><strong>DNS resolution</strong>: Sub-second response times</li>
<li><strong>Throughput</strong>: Sufficient for management and application traffic</li>
</ul>
<h3 id="cost-optimization">Cost Optimization<a hidden class="anchor" aria-hidden="true" href="#cost-optimization">#</a></h3>
<ul>
<li><strong>t3.micro instances</strong>: Free tier eligible</li>
<li><strong>NAT Gateway</strong>: ~$32/month (necessary for private subnet internet access)</li>
<li><strong>VPN Connection</strong>: ~$36/month (fixed cost)</li>
<li><strong>Route 53 Resolver</strong>: ~$0.125/hour per endpoint</li>
</ul>
<h2 id="future-enhancements">Future Enhancements<a hidden class="anchor" aria-hidden="true" href="#future-enhancements">#</a></h2>
<h3 id="planned-improvements">Planned Improvements<a hidden class="anchor" aria-hidden="true" href="#planned-improvements">#</a></h3>
<ol>
<li><strong>Certificate Management</strong>: Extend on-premises PKI to AWS services</li>
<li><strong>Service Mesh</strong>: Implement secure service-to-service communication</li>
<li><strong>Monitoring Integration</strong>: Centralized logging and monitoring</li>
<li><strong>Automation</strong>: Ansible playbooks for configuration management</li>
</ol>
<h3 id="scalability-considerations">Scalability Considerations<a hidden class="anchor" aria-hidden="true" href="#scalability-considerations">#</a></h3>
<ul>
<li><strong>Multi-AZ deployment</strong> for high availability</li>
<li><strong>Auto Scaling Groups</strong> for dynamic capacity</li>
<li><strong>Load balancers</strong> for service distribution</li>
<li><strong>Container orchestration</strong> for microservices</li>
</ul>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>This hybrid infrastructure implementation demonstrates enterprise-grade practices for securely connecting on-premises and cloud environments. The combination of proper network segmentation, security controls, and DNS integration provides a solid foundation for hybrid cloud operations.</p>
<p>Key achievements:</p>
<ul>
<li><strong>Secure VPN connectivity</strong> between environments</li>
<li><strong>Seamless DNS resolution</strong> across hybrid infrastructure</li>
<li><strong>Defense-in-depth security</strong> with multiple isolation layers</li>
<li><strong>Infrastructure as Code</strong> for reproducible deployments</li>
<li><strong>Scalable architecture</strong> ready for service expansion</li>
</ul>
<p>The pragmatic approach of using direct DNS zone management over complex delegation proved that sometimes the simplest solution that works is better than a theoretically perfect solution that doesn&rsquo;t. This infrastructure now serves as the foundation for deploying hybrid applications and services across both environments.</p>
<h2 id="technical-specifications">Technical Specifications<a hidden class="anchor" aria-hidden="true" href="#technical-specifications">#</a></h2>
<p><strong>Infrastructure Components:</strong></p>
<ul>
<li>AWS VPC with public/private subnets</li>
<li>Site-to-site VPN with static routing</li>
<li>Route 53 Resolver endpoints for DNS</li>
<li>EC2 instances with IAM roles</li>
<li>Security groups with least-privilege access</li>
</ul>
<p><strong>Network Architecture:</strong></p>
<ul>
<li>On-premises: Multiple VLANs (172.16.x.x/24, 172.21.21.0/24, 172.30.30.0/24)</li>
<li>AWS: 10.1.0.0/16 with /24 subnets</li>
<li>VPN: IPsec with AES256 encryption</li>
</ul>
<p><strong>DNS Architecture:</strong></p>
<ul>
<li>Samba4 AD DC: Authoritative for tillynet.lan and aws.tillynet.lan</li>
<li>Pi-hole: Recursive resolver with ad-blocking</li>
<li>Route 53: AWS service resolution and forwarding</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.tillynet.com/tags/aws/">AWS</a></li>
      <li><a href="https://blog.tillynet.com/tags/on-premise/">On-Premise</a></li>
      <li><a href="https://blog.tillynet.com/tags/hybrid/">Hybrid</a></li>
      <li><a href="https://blog.tillynet.com/tags/route/">Route</a></li>
      <li><a href="https://blog.tillynet.com/tags/dns/">Dns</a></li>
      <li><a href="https://blog.tillynet.com/tags/samba4/">Samba4</a></li>
      <li><a href="https://blog.tillynet.com/tags/ec2/">EC2</a></li>
      <li><a href="https://blog.tillynet.com/tags/bastion/">Bastion</a></li>
      <li><a href="https://blog.tillynet.com/tags/vpc/">VPC</a></li>
      <li><a href="https://blog.tillynet.com/tags/vpn/">VPN</a></li>
      <li><a href="https://blog.tillynet.com/tags/ipsec/">IPsec</a></li>
      <li><a href="https://blog.tillynet.com/tags/terraform/">Terraform</a></li>
      <li><a href="https://blog.tillynet.com/tags/pfsense/">PfSense</a></li>
      <li><a href="https://blog.tillynet.com/tags/infrastructure-as-code/">Infrastructure-as-Code</a></li>
      <li><a href="https://blog.tillynet.com/tags/network/">Network</a></li>
      <li><a href="https://blog.tillynet.com/tags/automation/">Automation</a></li>
      <li><a href="https://blog.tillynet.com/tags/cloud/">Cloud</a></li>
      <li><a href="https://blog.tillynet.com/tags/deployment/">Deployment</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://blog.tillynet.com/cloud-engineering-labs/aws-lab-3/establishing-aws-site-to-site-vpn-with-on-premise-pfsense-infrastructure/">
    <span class="title">Next »</span>
    <br>
    <span>Building a Hybrid Cloud: AWS Site-to-Site VPN with pfSense and Terraform</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://blog.tillynet.com/">Tilly Net</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
